## Listening / Reading / Writing ‚Äî –∞–Ω–∞–ª–∏–∑ –ø–æ—Ç–µ—Ä–∏ –æ—Ç–≤–µ—Ç–æ–≤ –∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

### 1. –°–∏–º–ø—Ç–æ–º—ã, –æ –∫–æ—Ç–æ—Ä—ã—Ö —Å–æ–æ–±—â–∞—é—Ç —É—á–µ–Ω–∏–∫–∏

- **–ü–æ–ª–Ω–∞—è –ø–æ—Ç–µ—Ä—è –æ—Ç–≤–µ—Ç–æ–≤ –ø—Ä–∏ —Å–∞–±–º–∏—Ç–µ**:
  - –£—á–µ–Ω–∏–∫ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –≤–æ –≤—Å–µ—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö Listening/Reading.
  - –ù–∞–∂–∏–º–∞–µ—Ç Submit.
  - –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –≤–∏–¥–∏—Ç, —á—Ç–æ —É –Ω–µ–≥–æ 0 –æ—Ç–≤–µ—Ç–æ–≤ / –≤—Å–µ –ø–æ–ª—è –∫–∞–∫ –±—É–¥—Ç–æ –ø—É—Å—Ç—ã–µ (`(empty)`), –ª–∏–±–æ —á–∞—Å—Ç—å –≤–æ–ø—Ä–æ—Å–æ–≤ –∏—Å—á–µ–∑–ª–∞.
  - –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –ø—Ä–∏–º–µ—Ä–Ω–æ —É **20%** —É—á–µ–Ω–∏–∫–æ–≤, —É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –≤—Å—ë –ø—Ä–æ—Ö–æ–¥–∏—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ.
- **–°–ø–æ–Ω—Ç–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã**:
  - –í–æ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ¬´—Å–∞–º–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è¬ª.
  - –í —á–∞—Å—Ç–∏ —Å–ª—É—á–∞–µ–≤ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è (–∫–∞–∫ –∏ –∑–∞–¥—É–º—ã–≤–∞–ª–æ—Å—å).
  - –í —á–∞—Å—Ç–∏ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (–æ—Å–æ–±–µ–Ω–Ω–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö) –æ—â—É—â–∞–µ—Ç—Å—è, —á—Ç–æ –≤—Å—ë ¬´–ø—Ä–æ–ø–∞–ª–æ¬ª.

### 2. –¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã (–ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞ –≤–µ—Ç–∫—É main)

#### 2.1. Listening

- –§—Ä–æ–Ω—Ç–µ–Ω–¥:
  - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: `ListeningTestPlayer.jsx`.
  - –•—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤:
    - `answers` –≤ React state.
    - `answersRef.current` –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ ¬´–∏—Å—Ç–∏–Ω–Ω–æ–≥–æ¬ª —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.
    - `localStorage` –ø–æ –∫–ª—é—á—É `listening_session_{sessionId}` (–æ—Ç–≤–µ—Ç—ã + —Ñ–ª–∞–≥–∏ + –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è).
  - –õ–æ–≥–∏–∫–∞:
    - –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ/–≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏:
      - POST `/listening-tests/{testId}/start/` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–µ—Å—Å–∏—é.
      - –ü–æ–¥–Ω–∏–º–∞—é—Ç—Å—è `answers` –∏ `flagged` —Å —Å–µ—Ä–≤–µ—Ä–∞.
      - –ï—Å–ª–∏ –µ—Å—Ç—å –∫—ç—à –≤ `localStorage`, –æ–Ω **–º–µ—Ä–¥–∂–∏—Ç—Å—è** –ø–æ–≤–µ—Ä—Ö —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à —Å—á–∏—Ç–∞–µ—Ç—Å—è –±–æ–ª–µ–µ —Å–≤–µ–∂–∏–º).
    - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:
      - `syncAnswers` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç PATCH `/listening-sessions/{id}/sync/` —Å `answers`, `flagged`, `time_left`.
      - –ü—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ (`visibilitychange`) –¥–µ–ª–∞–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π sync.
    - –°–∞–±–º–∏—Ç:
      - –ü–µ—Ä–µ–¥ —Å–∞–±–º–∏—Ç–æ–º –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `syncAnswers`.
      - –ó–∞—Ç–µ–º POST `/listening-sessions/{id}/submit/` —Å `{ answers, time_left }`.
      - –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–∞–±–º–∏—Ç–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à –æ—á–∏—â–∞–µ—Ç—Å—è.
- –ë—ç–∫–µ–Ω–¥:
  - –ú–æ–¥–µ–ª—å: `ListeningTestSession.answers` ‚Äî `JSONField` (dict).
  - `PATCH /listening-sessions/{id}/sync/`:

    ```2399:2567:backend/core/views.py
    answers_data = request.data.get('answers', {})
    ...
    if isinstance(answers_data, dict):
        for question_id, answer_value in answers_data.items():
            if isinstance(answer_value, dict) and question_id in session.answers and isinstance(session.answers[question_id], dict):
                session.answers[question_id].update(answer_value)
            else:
                session.answers[question_id] = answer_value
    ```

    - –í–∞–∂–Ω–æ: **–º–µ—Ä–¥–∂–∏—Ç** –æ—Ç–≤–µ—Ç—ã, –Ω–µ –∑–∞—Ç–∏—Ä–∞—è —Å—Ç–∞—Ä—ã–µ.
  - –°–∞–±–º–∏—Ç listening —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:
    - –ß–µ—Ä–µ–∑ `ListeningTestSessionView.post(..., session_id=...)` (–Ω–æ–≤—ã–π, JWT —á–µ—Ä–µ–∑ `Authorization: Bearer`).
    - –ß–µ—Ä–µ–∑ `SubmitListeningTestView` (—Å—Ç–∞—Ä—ã–π Firebase-–ø—É—Ç—å, —Å–µ–π—á–∞—Å —Ñ—Ä–æ–Ω—Ç –µ–≥–æ, —Å—É–¥—è –ø–æ –∫–æ–¥—É, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç).
  - –í `ListeningTestSessionView.post(..., session_id=...)`:

    ```2401:2525:backend/core/views.py
    submit_serializer = ListeningTestSessionSubmitSerializer(session, data=request.data, partial=True)
    submit_serializer.is_valid(raise_exception=True)
    session.answers = submit_serializer.validated_data.get('answers', session.answers)
    session.time_left = submit_serializer.validated_data.get('time_left', session.time_left)
    session.submitted = True
    ...
    session.save()
    ```

    - –ó–¥–µ—Å—å `session.answers` **–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è** —Å–æ–¥–µ—Ä–∂–∏–º—ã–º `answers` –∏–∑ –∑–∞–ø—Ä–æ—Å–∞.
  - –í `SubmitListeningTestView` (—Å—Ç–∞—Ä—ã–π –ø—É—Ç—å) —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∞–∫–∫—É—Ä–∞—Ç–Ω–∞—è **–º–µ—Ä–¥–∂-–ª–æ–≥–∏–∫–∞**:

    ```2146:2183:backend/core/views.py
    answers_data = request.data.get("answers", {})
    if not isinstance(session.answers, dict):
        session.answers = {}
    if isinstance(answers_data, dict):
        for question_id, answer_value in answers_data.items():
            if isinstance(answer_value, dict) and question_id in session.answers and isinstance(session.answers[question_id], dict):
                session.answers[question_id].update(answer_value)
            else:
                session.answers[question_id] = answer_value
    else:
        session.answers = answers_data if isinstance(answers_data, dict) else {}
    ```

- –í—ã–≤–æ–¥ –ø–æ Listening:
  - –ü–æ–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç —Ä–µ—à–∞–µ—Ç —Ç–µ—Å—Ç, sync –Ω–∞–¥—ë–∂–µ–Ω: –æ–Ω –º–µ—Ä–¥–∂–∏—Ç –æ—Ç–≤–µ—Ç—ã.
  - –ü—Ä–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º —Å–∞–±–º–∏—Ç–µ —á–µ—Ä–µ–∑ `ListeningTestSessionView` –ª—é–±–æ–µ ¬´–∫—Ä–∏–≤–æ–µ¬ª —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ —Å –ø—É—Å—Ç—ã–º/—á–∞—Å—Ç–∏—á–Ω—ã–º `answers` **–∑–∞—Ç–∏—Ä–∞–µ—Ç** —É–∂–µ –Ω–∞—Å–∏–Ω–∫–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –≤ `session.answers`.

#### 2.2. Reading

- –§—Ä–æ–Ω—Ç–µ–Ω–¥:
  - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: `ReadingTestPlayer.jsx`.
  - –•—Ä–∞–Ω–µ–Ω–∏–µ:
    - `answers` + `answersRef`.
    - `localStorage` –ø–æ –∫–ª—é—á—É `reading_session_{sessionId}`.
  - –õ–æ–≥–∏–∫–∞:
    - POST `/reading-tests/{testId}/start/` ‚Äî —Å–æ–∑–¥–∞—ë—Ç/–≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–µ—Å—Å–∏—é (—Å —É—á—ë—Ç–æ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ñ–ª–∞–≥–∞).
    - –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø–æ–¥–Ω–∏–º–∞—é—Ç—Å—è `answers` —Å —Å–µ—Ä–≤–µ—Ä–∞, –ø–æ—Ç–æ–º –ø–æ–≤–µ—Ä—Ö –º–µ—Ä–∂–∏—Ç—Å—è –∫—ç—à –∏–∑ `localStorage`, –ø–ª—é—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–∞–±–ª–∏—Ü –∫ –Ω–æ–≤–æ–º—É (–≤—Å–µ —è—á–µ–π–∫–∏ –∫–∞–∫ –ø–ª–æ—Å–∫–∏–µ –∫–ª—é—á–∏ `questionId__rXcY__gapN`).
    - `syncAnswers` ‚Üí PATCH `/reading-sessions/{id}/sync/`, —Å –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–º –º–µ—Ä–¥–∂–µ–º –Ω–∞ –±—ç–∫–µ.
    - –°–∞–±–º–∏—Ç:
      - –°–Ω–∞—á–∞–ª–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `syncAnswers`.
      - –ü–æ—Ç–æ–º `api.put('/reading-sessions/{id}/submit/', { answers: payloadAnswers, time_left })` —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–µ–π —Ç–∞–±–ª–∏—Ü –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π.
- –ë—ç–∫–µ–Ω–¥:
  - –ú–æ–¥–µ–ª—å: `ReadingTestSession.answers` ‚Äî `JSONField` (dict).
  - `PATCH /reading-sessions/{id}/sync/`:

    ```3359:3397:backend/core/views.py
    if isinstance(answers_data, dict):
        for question_id, answer_value in answers_data.items():
            if isinstance(answer_value, dict) and question_id in session.answers and isinstance(session.answers[question_id], dict):
                session.answers[question_id].update(answer_value)
            else:
                session.answers[question_id] = answer_value
    else:
        session.answers = answers_data if isinstance(answers_data, dict) else {}
    session.save(update_fields=['answers', 'time_left_seconds'])
    ```

  - `PUT /reading-sessions/{id}/submit/`:

    ```3334:3352:backend/core/views.py
    answers_data = request.data.get('answers', {})
    time_left = request.data.get('time_left')
    session.answers = answers_data
    ...
    session.completed = True
    session.save(update_fields=['answers', 'time_left_seconds', 'end_time', 'completed'])
    ```

  - –ó–¥–µ—Å—å `session.answers` **–ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ—Ç—Å—è** –Ω–∞ —Ç–æ, —á—Ç–æ –ø—Ä–∏—à–ª–æ –≤ `answers` –∑–∞–ø—Ä–æ—Å–∞.

- –í—ã–≤–æ–¥ –ø–æ Reading:
  - Sync —Å–¥–µ–ª–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ (–º–µ—Ä–¥–∂), –Ω–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π submit –≤ `ReadingTestSessionView.put` –∂—ë—Å—Ç–∫–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç `answers`.
  - –õ—é–±–æ–π —Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ `answers` –≤ –∑–∞–ø—Ä–æ—Å–µ —Å–∞–±–º–∏—Ç–∞ –ø—É—Å—Ç–æ–π/—á–∞—Å—Ç–∏—á–Ω—ã–π (—Å–µ—Ç–µ–≤–æ–π —Å–±–æ–π, –æ—à–∏–±–∫–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏, –Ω–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π `answersRef`), –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–æ—Ç–µ—Ä–µ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

#### 2.3. Writing

- –§—Ä–æ–Ω—Ç–µ–Ω–¥:
  - –°—Ç—Ä–∞–Ω–∏—Ü–∞: `WritingTaskPage.js`.
  - –•—Ä–∞–Ω–µ–Ω–∏–µ:
    - `task1Text`/`task2Text` –≤ —Å—Ç–µ–π—Ç–µ.
    - `localStorage` –ø–æ –∫–ª—é—á–∞–º `writing_task1_{sessionId}`, `writing_task2_{sessionId}` –∏ `writing_deadline_{sessionId}`.
  - –õ–æ–≥–∏–∫–∞:
    - –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–¥–Ω–∏–º–∞–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –∏–∑ `localStorage`.
    - –ö–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Ç—É—Ç –∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –≤ `localStorage`.
    - –ö–∞–∂–¥—ã–µ 12 —Å–µ–∫—É–Ω–¥ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `syncDraft`, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç:

      ```116:123:frontend/src/pages/WritingTaskPage.js
      await api.patch(`/writing-sessions/${sessionId}/sync/`, {
        task1_text: task1Text,
        task2_text: task2Text,
        time_left: ...
      });
      ```

    - –ü—Ä–∏ —Å–∞–±–º–∏—Ç–µ:
      - –î–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö POST `/submit-task/` —Å `task1` –∏ `task2`.
      - –ó–∞—Ç–µ–º POST `/finish-writing-session/`.
      - –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫—ç—à –ø–æ —ç—Ç–æ–º—É sessionId —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ `localStorage`.
- –ë—ç–∫–µ–Ω–¥:
  - –í `backend/core/urls.py` –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ:

    ```123:157:backend/core/urls.py
    path('writing-tests/<int:test_id>/start/', StartWritingSessionView.as_view(), ...),
    path('writing-test-sessions/<int:session_id>/', WritingTestSessionDetailView.as_view(), ...),
    path('start-writing-session/', StartWritingSessionView.as_view(), ...),
    path('submit-task/', SubmitTaskView.as_view(), ...),
    path('finish-writing-session/', FinishWritingSessionView.as_view(), ...),
    ```

  - –≠–Ω–¥–ø–æ–∏–Ω—Ç–∞ `/writing-sessions/{id}/sync/` **–Ω–µ—Ç**.

- –í—ã–≤–æ–¥ –ø–æ Writing:
  - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π `syncDraft` –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ –±—å—ë—Ç –≤ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π URL, —Ç.–µ. —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –æ–Ω –Ω–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç.
  - –†–µ–∞–ª—å–Ω–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `localStorage` –±—Ä–∞—É–∑–µ—Ä–∞.
  - –ü—Ä–∏ —Ä–µ—Ñ—Ä–µ—à–µ –≤ **—Ç–æ–º –∂–µ –±—Ä–∞—É–∑–µ—Ä–µ** –∏ –ø—Ä–∏ –∂–∏–≤–æ–º `localStorage` —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –ø–æ–¥–Ω–∏–º—É—Ç—Å—è; –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ `localStorage` (–¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä / –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —Ä–µ–∂–∏–º / –æ—á–∏—Å—Ç–∫–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â) ‚Äî –≤—Å—ë, —á—Ç–æ –Ω–µ –¥–æ—à–ª–æ –¥–æ `/submit-task/`, –ø—Ä–æ–ø–∞–¥–∞–µ—Ç.

### 3. –ö–æ—Ä–Ω–µ–≤—ã–µ –ø—Ä–∏—á–∏–Ω—ã –ø–æ—Ç–µ—Ä–∏ –æ—Ç–≤–µ—Ç–æ–≤ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –∫–æ–¥–æ–º)

1. **–ì–ª–∞–≤–Ω–æ–µ —Å–ª–∞–±–æ–µ –º–µ—Å—Ç–æ ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω—ã–π submit (—Ñ–∞–∫—Ç –∏–∑ –∫–æ–¥–∞)**:
   - **Listening** (`backend/core/views.py`, —Å—Ç—Ä–æ–∫–∞ 2483):
     ```python
     session.answers = submit_serializer.validated_data.get('answers', session.answers)
     ```
     - –ï—Å–ª–∏ `validated_data.get('answers')` –≤–µ—Ä–Ω—ë—Ç `None` –∏–ª–∏ –ø—É—Å—Ç–æ–π `{}`, fallback `session.answers` –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - **Reading** (`backend/core/views.py`, —Å—Ç—Ä–æ–∫–∞ 3344):
     ```python
     answers_data = request.data.get('answers', {})
     session.answers = answers_data  # –ü—Ä—è–º–∞—è –∑–∞–º–µ–Ω–∞ –±–µ–∑ fallback
     ```
     - **–ö—Ä–∏—Ç–∏—á–Ω–µ–µ**, —á–µ–º Listening ‚Äî –∑–¥–µ—Å—å –Ω–µ—Ç –¥–∞–∂–µ –ø–æ–ø—ã—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
   - **–§–∞–∫—Ç**: –æ–±–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ **–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç** `session.answers` –≤–º–µ—Å—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –º–µ—Ä–¥–∂–∞

2. **–ö–æ–≥–¥–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–π payload (—Ñ–∞–∫—Ç—ã –∏–∑ –∫–æ–¥–∞)**:
   - **Listening** (`ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∞ 489):
     ```javascript
     const payloadAnswers = answersRef.current || answers;
     ```
     - –ï—Å–ª–∏ `answersRef.current` –ø—É—Å—Ç–æ–π `{}` –∏ `answers` (state) —Ç–æ–∂–µ –ø—É—Å—Ç–æ–π ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è `{}`
   - **Reading** (`ReadingTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∞ 404):
     ```javascript
     let payloadAnswers = answersRef.current || answers || {};
     ```
     - –ï—Å–ª–∏ –æ–±–∞ –ø—É—Å—Ç—ã–µ ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è `{}` (—è–≤–Ω—ã–π fallback)
   - **–ö–æ–≥–¥–∞ —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏**:
     - Race condition –º–µ–∂–¥—É `syncAnswers()` –∏ `submitTest()` (–æ–±–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ)
     - –ü–µ—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è `answersRef.current` –∏–∑ `localStorage`
     - –û—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ `localStorage` (try-catch –≤ —Å—Ç—Ä–æ–∫–∞—Ö 128-130 `ListeningTestPlayer.jsx` —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ—Ç warning)

3. **–ü–æ—á–µ–º—É –±–∞–≥ –±—ã–ª –¥–æ sync –∏ –æ—Å—Ç–∞–ª—Å—è –ø–æ—Å–ª–µ (—Ñ–∞–∫—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ Git)**:
   - **–î–æ sync** (–∫–æ–º–º–∏—Ç –¥–æ `68dc11f9`): 
     - –§—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–ª `{ answers, time_left }` –≥–¥–µ `answers` ‚Äî —ç—Ç–æ **React state**
     - –ö–æ–¥: `await api.post(..., { answers, time_left: remaining })` ‚Äî `answers` –∏–∑ state
     - **–ù–û**: React state `answers` –º–æ–≥ –±—ã—Ç—å –ø—É—Å—Ç—ã–º `{}` –≤ –º–æ–º–µ–Ω—Ç submit –∏–∑-–∑–∞:
       - –ü–µ—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ ‚Üí state —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤ `useState({})`
       - –û—à–∏–±–∫–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–∑ localStorage ‚Üí state –æ—Å—Ç–∞—ë—Ç—Å—è –ø—É—Å—Ç—ã–º
       - Race conditions –º–µ–∂–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ state (React state –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ)
       - –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π state –ø—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
     - –ï—Å–ª–∏ `answers = {}` ‚Üí submit –æ—Ç–ø—Ä–∞–≤–ª—è–ª –ø—É—Å—Ç–æ–π payload ‚Üí –±—ç–∫–µ–Ω–¥ —Å—Ç–∏—Ä–∞–ª –¥–∞–Ω–Ω—ã–µ
   - **Sync –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ –ø–æ–ø—ã—Ç–∫–∞ —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É**:
     - –ò–¥–µ—è: —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –æ—Ç–≤–µ—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ –ø—É—Ç–∏ —á–µ—Ä–µ–∑ sync, —á—Ç–æ–±—ã –¥–∞–∂–µ –µ—Å–ª–∏ state –ø—É—Å—Ç–æ–π, –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
     - –ù–æ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–ª–∞—Å—å, –ø–æ—Ç–æ–º—É —á—Ç–æ submit **–≤—Å—ë –µ—â—ë –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç** `session.answers` –ø—É—Å—Ç—ã–º payload
   - **–ü–æ—Å–ª–µ sync** (–∫–æ–º–º–∏—Ç `68dc11f9` –∏ –æ—Å–æ–±–µ–Ω–Ω–æ `3dc2e0d8`):
     - –î–æ–±–∞–≤–∏–ª—Å—è `await syncAnswers();` **–ø–µ—Ä–µ–¥** submit (—Å—Ç—Ä–æ–∫–∞ 488)
     - –ò–∑–º–µ–Ω–∏–ª—Å—è payload: `const payloadAnswers = answersRef.current || answers;` (—Å—Ç—Ä–æ–∫–∞ 489)
     - **–ü—Ä–æ–±–ª–µ–º–∞ —É—Å—É–≥—É–±–∏–ª–∞—Å—å**: —Ç–µ–ø–µ—Ä—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ **–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è** –Ω–∞ `answersRef.current`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º –ø–æ —Ç–µ–º –∂–µ –ø—Ä–∏—á–∏–Ω–∞–º, —á—Ç–æ –∏ state —Ä–∞–Ω—å—à–µ
     - –ï—Å–ª–∏ `payloadAnswers = {}` ‚Üí submit —Å—Ç–∏—Ä–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ sync —É—Å–ø–µ–ª —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
   - **–í—ã–≤–æ–¥**: 
     - –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ **–∏ –¥–æ sync, –∏ –ø–æ—Å–ª–µ sync**
     - –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞: –±—ç–∫–µ–Ω–¥ **–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç** `session.answers` –≤–º–µ—Å—Ç–æ –º–µ—Ä–¥–∂–∞
     - Sync –Ω–µ —Ä–µ—à–∏–ª –ø—Ä–æ–±–ª–µ–º—É, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π submit –≤—Å—ë –µ—â—ë –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –ø—É—Å—Ç–æ–π payload –∏ —Å—Ç–µ—Ä–µ—Ç—å –¥–∞–Ω–Ω—ã–µ
     - –†–µ—à–µ–Ω–∏–µ: –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å submit –±–µ–∑–æ–ø–∞—Å–Ω—ã–º (–º–µ—Ä–¥–∂ –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏), —á—Ç–æ–±—ã –¥–∞–∂–µ –ø—Ä–∏ –ø—É—Å—Ç–æ–º payload –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ç–µ—Ä—è–ª–∏—Å—å

4. **–°–ø–æ–Ω—Ç–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—Ñ–∞–∫—Ç—ã –∏–∑ –∫–æ–¥–∞)**:
   - –í `frontend/src/firebase.js` (—Å—Ç—Ä–æ–∫–∏ 48-50): –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `window.location.href = '/login'`
   - –≠—Ç–æ –º–æ–∂–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ ¬´—Å–ø–æ–Ω—Ç–∞–Ω–Ω—ã–π —Ä–µ—Ñ—Ä–µ—à¬ª –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - Listening/Reading —Å–∞–º–∏ –ø–æ —Å–µ–±–µ –Ω–µ –≤—ã–∑—ã–≤–∞—é—Ç `reload()`
   - –ü—Ä–∏ —Ä–µ—Ñ—Ä–µ—à–µ:
     - –ï—Å–ª–∏ sync —É—Å–ø–µ–ª —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç—ã + `localStorage` –∂–∏–≤ ‚Üí –æ—Ç–≤–µ—Ç—ã –ø–æ–¥–Ω–∏–º—É—Ç—Å—è (—Ñ–∞–∫—Ç –∏–∑ –∫–æ–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤ `startSession`)
     - –ï—Å–ª–∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π submit –ø–æ—Å–ª–µ —Ä–µ—Ñ—Ä–µ—à–∞ —É–π–¥—ë—Ç —Å –ø—É—Å—Ç—ã–º payload ‚Üí –æ—Ç–≤–µ—Ç—ã –±—É–¥—É—Ç —Å—Ç—ë—Ä—Ç—ã (—Ñ–∞–∫—Ç –∏–∑ –ª–æ–≥–∏–∫–∏ submit)

### 4. –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ñ–∞–∫—Ç—ã –∏–∑ –∫–æ–¥–∞ –∏ –∏—Å—Ç–æ—Ä–∏–∏ Git (100% –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ)

#### 4.1. Listening Submit ‚Äî —Ñ–∞–∫—Ç—ã

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (—Ñ–∞–∫—Ç):**
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ (`ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∏ 493, 498): –≤—ã–∑—ã–≤–∞–µ—Ç `POST /listening-sessions/${session.id}/submit/` —Å payload `{ answers: payloadAnswers, time_left: remaining }`
- –ë—ç–∫–µ–Ω–¥ (`backend/core/views.py`, —Å—Ç—Ä–æ–∫–∞ 2483): `ListeningTestSessionView.post(..., session_id=...)` –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
  ```python
  session.answers = submit_serializer.validated_data.get('answers', session.answers)
  ```
- URL –º–∞—Ä—à—Ä—É—Ç (`backend/core/urls.py`, —Å—Ç—Ä–æ–∫–∞ 175): `path('listening-sessions/<int:session_id>/submit/', ListeningTestSessionView.as_view())`

**–ò—Å—Ç–æ—Ä–∏—è Git (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ —á–µ—Ä–µ–∑ `git show`):**
- –í –∫–æ–º–º–∏—Ç–µ `68dc11f9` (fix autosave listening reading, sync) —É–∂–µ –±—ã–ª–∞ **—Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞**: `session.answers = submit_serializer.validated_data.get('answers', session.answers)`
- –°—Ç–∞—Ä—ã–π `SubmitListeningTestView` (—Å—Ç—Ä–æ–∫–∏ 2146-2208) —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –º–µ—Ä–¥–∂–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –∫–æ–¥–µ, –Ω–æ **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** ‚Äî –µ–≥–æ –Ω–µ—Ç –≤ `urls.py`

**–ü—Ä–æ–±–ª–µ–º–∞ (—Ñ–∞–∫—Ç, –Ω–µ –≥–∏–ø–æ—Ç–µ–∑–∞):**
- –ï—Å–ª–∏ `submit_serializer.validated_data.get('answers')` –≤–µ—Ä–Ω—ë—Ç `None` –∏–ª–∏ –ø—É—Å—Ç–æ–π `{}`, —Ç–æ `session.answers` –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω —ç—Ç–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
- –ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–∏—Ç `payloadAnswers = {}` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `answersRef.current` –∏ `answers` –æ–±–∞ –ø—É—Å—Ç—ã–µ), —Ç–æ –≤—Å–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ sync –æ—Ç–≤–µ—Ç—ã –±—É–¥—É—Ç —Å—Ç—ë—Ä—Ç—ã

#### 4.2. Reading Submit ‚Äî —Ñ–∞–∫—Ç—ã

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (—Ñ–∞–∫—Ç):**
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ (`ReadingTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∏ 433, 439): –≤—ã–∑—ã–≤–∞–µ—Ç `PUT /reading-sessions/${session.id}/submit/` —Å payload `{ answers: payloadAnswers, time_left: remaining }`
- –ë—ç–∫–µ–Ω–¥ (`backend/core/views.py`, —Å—Ç—Ä–æ–∫–∞ 3344): `ReadingTestSessionView.put` –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
  ```python
  answers_data = request.data.get('answers', {})
  session.answers = answers_data  # –ü–†–Ø–ú–ê–Ø –ó–ê–ú–ï–ù–ê –ë–ï–ó –ú–ï–†–î–ñ–ê
  ```
- URL –º–∞—Ä—à—Ä—É—Ç (`backend/core/urls.py`, —Å—Ç—Ä–æ–∫–∞ 190): `path('reading-sessions/<int:session_id>/submit/', ReadingTestSessionView.as_view())`

**–ò—Å—Ç–æ—Ä–∏—è Git (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ —á–µ—Ä–µ–∑ `git show`):**
- –í –∫–æ–º–º–∏—Ç–µ `68dc11f9` —É–∂–µ –±—ã–ª–∞ **—Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞**: `session.answers = answers_data` (–ø—Ä—è–º–∞—è –∑–∞–º–µ–Ω–∞)
- –ü—Ä–æ–±–ª–µ–º–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞ —Å —Å–∞–º–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è `ReadingTestSessionView`

**–ü—Ä–æ–±–ª–µ–º–∞ (—Ñ–∞–∫—Ç, –Ω–µ –≥–∏–ø–æ—Ç–µ–∑–∞):**
- –ï—Å–ª–∏ `answers_data` –ø—É—Å—Ç–æ–π `{}` –∏–ª–∏ `None`, —Ç–æ `session.answers` –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å—Ç–∏—Ä–∞–µ—Ç—Å—è
- –≠—Ç–æ **–∫—Ä–∏—Ç–∏—á–Ω–µ–µ**, —á–µ–º –≤ Listening, –ø–æ—Ç–æ–º—É —á—Ç–æ –∑–¥–µ—Å—å –Ω–µ—Ç –¥–∞–∂–µ fallback –Ω–∞ `session.answers` ‚Äî –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å

#### 4.3. Writing Sync ‚Äî —Ñ–∞–∫—Ç—ã

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (—Ñ–∞–∫—Ç):**
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ (`WritingTaskPage.js`, —Å—Ç—Ä–æ–∫–∞ 123): –≤—ã–∑—ã–≤–∞–µ—Ç `PATCH /writing-sessions/${sessionId}/sync/` –∫–∞–∂–¥—ã–µ 12 —Å–µ–∫—É–Ω–¥
- –ë—ç–∫–µ–Ω–¥: —Ç–∞–∫–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ **–ù–ï–¢** –≤ `backend/core/urls.py`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ `grep`: –≤ `urls.py` –Ω–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞, —Å–æ–¥–µ—Ä–∂–∞—â–µ–≥–æ `writing-sessions.*sync`

**–ò—Å—Ç–æ—Ä–∏—è Git (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ):**
- –ü–æ `git log --all --grep="writing.*sync"` –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä—É –∏—Å—Ç–æ—Ä–∏–∏ `urls.py` ‚Äî —Ç–∞–∫–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–ª–æ
- –§—Ä–æ–Ω—Ç–µ–Ω–¥-–∫–æ–¥ —Å –≤—ã–∑–æ–≤–æ–º `/writing-sessions/${sessionId}/sync/` –ø–æ—è–≤–∏–ª—Å—è, –Ω–æ –±—ç–∫–µ–Ω–¥-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞

**–ü—Ä–æ–±–ª–µ–º–∞ (—Ñ–∞–∫—Ç, –Ω–µ –≥–∏–ø–æ—Ç–µ–∑–∞):**
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã `PATCH /writing-sessions/${sessionId}/sync/` –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 404
- –ß–µ—Ä–Ω–æ–≤–∏–∫–∏ –∂–∏–≤—É—Ç **—Ç–æ–ª—å–∫–æ** –≤ `localStorage` –∏ –≤ –ø–∞–º—è—Ç–∏ React-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
- –ü—Ä–∏ –ø–æ—Ç–µ—Ä–µ `localStorage` (–¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —Ä–µ–∂–∏–º, –æ—á–∏—Å—Ç–∫–∞) —á–µ—Ä–Ω–æ–≤–∏–∫–∏ —Ç–µ—Ä—è—é—Ç—Å—è –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ

#### 4.4. Sync Endpoints ‚Äî —Ñ–∞–∫—Ç—ã

**Listening Sync (PATCH `/listening-sessions/<id>/sync/`):**
- –ë—ç–∫–µ–Ω–¥ (`backend/core/views.py`, —Å—Ç—Ä–æ–∫–∏ 2544-2552): **–º–µ—Ä–¥–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ** ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏, –Ω–µ —Å—Ç–∏—Ä–∞–µ—Ç –æ—Å—Ç–∞–ª—å–Ω—ã–µ
- –§–∞–∫—Ç: –ª–æ–≥–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è

**Reading Sync (PATCH `/reading-sessions/<id>/sync/`):**
- –ë—ç–∫–µ–Ω–¥ (`backend/core/views.py`, —Å—Ç—Ä–æ–∫–∏ 3376-3384): **–º–µ—Ä–¥–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ** ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏
- –§–∞–∫—Ç: –ª–æ–≥–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è

**–í—ã–≤–æ–¥:** Sync-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –ü—Ä–æ–±–ª–µ–º–∞ **—Ç–æ–ª—å–∫–æ** –≤ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö submit-—ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö.

#### 4.5. –§—Ä–æ–Ω—Ç–µ–Ω–¥ ‚Äî —Ñ–∞–∫—Ç—ã –æ —Ç–æ–º, –∫–æ–≥–¥–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π payload

**Listening (`ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∞ 489):**
```javascript
const payloadAnswers = answersRef.current || answers;
```
- –ï—Å–ª–∏ `answersRef.current` –ø—É—Å—Ç–æ–π `{}` –∏ `answers` (state) —Ç–æ–∂–µ –ø—É—Å—Ç–æ–π `{}`, —Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è `{}`
- –ï—Å–ª–∏ `answersRef.current` `undefined`/`null`, —Ç–æ –≤–æ–∑—å–º—ë—Ç—Å—è `answers` –∏–∑ state

**Reading (`ReadingTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∞ 404):**
```javascript
let payloadAnswers = answersRef.current || answers || {};
```
- –ï—Å–ª–∏ –æ–±–∞ –ø—É—Å—Ç—ã–µ, –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è `{}` (—è–≤–Ω—ã–π fallback)

**–ö–æ–≥–¥–∞ —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ (—Ñ–∞–∫—Ç—ã –∏–∑ –∫–æ–¥–∞):**
- –ü—Ä–∏ —Ä–µ–¥–∫–∏—Ö race conditions –º–µ–∂–¥—É `syncAnswers()` –∏ `submitTest()` (–æ–±–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ)
- –ï—Å–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–µ—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–ª—Å—è –∏ `answersRef.current` –Ω–µ —É—Å–ø–µ–ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –∏–∑ `localStorage`
- –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ø–∞—Ä—Å–∏–Ω–≥–∞ `localStorage` (try-catch –≤ —Å—Ç—Ä–æ–∫–∞—Ö 128-130 `ListeningTestPlayer.jsx` –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç warning, –Ω–æ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ)

### 5. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ñ–∏–∫—Å–æ–≤ (–±–µ–∑ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)

**–í–∞–∂–Ω–æ**: –ü—Ä–æ–±–ª–µ–º–∞ –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:
1. **–§—Ä–æ–Ω—Ç–µ–Ω–¥**: payload —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø—É—Å—Ç—ã–º –∏–∑-–∑–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (—Ä–∞–∑–¥–µ–ª 7.3)
2. **–ë—ç–∫–µ–Ω–¥**: submit –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤–º–µ—Å—Ç–æ –º–µ—Ä–¥–∂–∞ (—Ä–∞–∑–¥–µ–ª 6)

**–†–µ—à–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–º:**
- –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥, —á—Ç–æ–±—ã payload –Ω–µ –±—ã–ª –ø—É—Å—Ç—ã–º (–æ—Å–æ–±–µ–Ω–Ω–æ `loadSession` –¥–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–ª—è—Ç—å `answersRef`)
- –ò—Å–ø—Ä–∞–≤–∏—Ç—å –±—ç–∫–µ–Ω–¥, —á—Ç–æ–±—ã –¥–∞–∂–µ –ø—Ä–∏ –ø—É—Å—Ç–æ–º payload –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ç–µ—Ä—è–ª–∏—Å—å (–º–µ—Ä–¥–∂ –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏)

1. **Listening submit**:
   - –í `ListeningTestSessionView.post(..., session_id=...)`:
     - –ï—Å–ª–∏ `answers` –≤ –∑–∞–ø—Ä–æ—Å–µ:
       - –Ω–µ `dict` ‚Üí **–Ω–µ —Ç—Ä–æ–≥–∞—Ç—å** `session.answers`.
       - `dict` ‚Üí **–º–µ—Ä–¥–∂–∏—Ç—å** –ø–æ –∫–ª—é—á–∞–º, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ `patch`:
         - –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –æ–±—ä–µ–¥–∏–Ω—è—Ç—å —Å–ª–æ–≤–∞—Ä–∏;
         - –¥–ª—è –ø–ª–æ—Å–∫–∏—Ö –∫–ª—é—á–µ–π –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è—Ç—å/–¥–æ–±–∞–≤–ª—è—Ç—å.
   - –≠—Ç–æ —Å–¥–µ–ª–∞–µ—Ç submit –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º –∏ —É—Å—Ç–æ–π—á–∏–≤—ã–º –∫ –ø—É—Å—Ç—ã–º/—á–∞—Å—Ç–∏—á–Ω—ã–º payload.

2. **Reading submit**:
   - –í `ReadingTestSessionView.put`:
     - –ó–∞–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É ¬´`session.answers = answers_data`¬ª –Ω–∞:
       - –µ—Å–ª–∏ `answers_data` –Ω–µ `dict` –∏–ª–∏ –ø—É—Å—Ç–æ–π ‚Üí –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–µ `session.answers`;
       - –µ—Å–ª–∏ `dict` ‚Üí –ø—Ä–æ–π—Ç–∏—Å—å –ø–æ –∫–ª—é—á–∞–º –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ—Ç–≤–µ—Ç—ã / –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ, –Ω–µ —Å—Ç–∏—Ä–∞—è –æ—Å—Ç–∞–ª—å–Ω—ã–µ.

3. **Writing sync**:
   - –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è sync —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤:
     - –ù–∞–ø—Ä–∏–º–µ—Ä, `PATCH /writing-test-sessions/<id>/` –∫–æ—Ç–æ—Ä—ã–π –æ–±–Ω–æ–≤–ª—è–µ—Ç `task1_draft`, `task2_draft`, `time_left_seconds`.
   - –ù–∞ —Ñ—Ä–æ–Ω—Ç–µ:
     - –ó–∞–º–µ–Ω–∏—Ç—å URL `/writing-sessions/${sessionId}/sync/` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π —Ä–∞–±–æ—á–∏–π –º–∞—Ä—à—Ä—É—Ç.
   - –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –¥–∞–∂–µ –ø–æ—Å–ª–µ –ø–æ—Ç–µ—Ä–∏ `localStorage` (–ø–æ –∫—Ä–∞–π–Ω–µ–π –º–µ—Ä–µ —Å —Ç–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –≥–¥–µ —à—ë–ª —Ç–µ—Å—Ç).

4. **–ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ–≥–æ logout/refresh**:
   - –ë–æ–ª–µ–µ –º—è–≥–∫–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏—Å—Ç–µ—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞:
     - –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ `window.location.href = '/login'` –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –¥–∞–≤–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ—Å–∞–±–º–∏—Ç–∏—Ç—å —Ç–µ—Å—Ç (–µ—Å–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ).
   - –î–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
     - –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–∞–±–º–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –ª–æ–≥ —Å–µ—Ä–≤–µ—Ä–∞:
       - —Ä–∞–∑–º–µ—Ä –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É `answers` –¥–æ –∏ –ø–æ—Å–ª–µ submit;
       - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –±—Ä–∞—É–∑–µ—Ä (–µ—Å–ª–∏ –µ—Å—Ç—å user-agent).
   - –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç —Ç–æ—á–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–ª–∏ –æ–ø—Ä–æ–≤–µ—Ä–≥–Ω—É—Ç—å –≥–∏–ø–æ—Ç–µ–∑—É –æ ¬´–ø—É—Å—Ç–æ–º payload¬ª –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö.

### 6. –ò—Ç–æ–≥ (100% –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ñ–∞–∫—Ç—ã)

**–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:**
- Sync-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (`PATCH /listening-sessions/<id>/sync/`, `PATCH /reading-sessions/<id>/sync/`) **–º–µ—Ä–¥–∂–∞—Ç** –æ—Ç–≤–µ—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏ –Ω–µ —Å—Ç–∏—Ä–∞—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ.
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç—ã –≤ `localStorage` –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏—Ö –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ.

**–ö–æ—Ä–Ω–µ–≤—ã–µ –ø—Ä–∏—á–∏–Ω—ã –ø–æ—Ç–µ—Ä–∏ –æ—Ç–≤–µ—Ç–æ–≤ (—Ñ–∞–∫—Ç—ã –∏–∑ –∫–æ–¥–∞):**

1. **Listening Submit** (`POST /listening-sessions/<id>/submit/`):
   - –°—Ç—Ä–æ–∫–∞ 2483 `backend/core/views.py`: `session.answers = submit_serializer.validated_data.get('answers', session.answers)`
   - –ï—Å–ª–∏ `validated_data.get('answers')` –≤–µ—Ä–Ω—ë—Ç `None` –∏–ª–∏ –ø—É—Å—Ç–æ–π `{}`, —Ç–æ fallback `session.answers` **–Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç**, –ø–æ—Ç–æ–º—É —á—Ç–æ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –ø—É—Å—Ç–æ–π dict
   - **–§–∞–∫—Ç**: –ø—Ä–∏ –ø—É—Å—Ç–æ–º payload –≤—Å–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ sync –æ—Ç–≤–µ—Ç—ã —Å—Ç–∏—Ä–∞—é—Ç—Å—è

2. **Reading Submit** (`PUT /reading-sessions/<id>/submit/`):
   - –°—Ç—Ä–æ–∫–∞ 3344 `backend/core/views.py`: `session.answers = answers_data` (–ø—Ä—è–º–∞—è –∑–∞–º–µ–Ω–∞ –±–µ–∑ fallback)
   - **–§–∞–∫—Ç**: —ç—Ç–æ **–∫—Ä–∏—Ç–∏—á–Ω–µ–µ**, —á–µ–º Listening ‚Äî –∑–¥–µ—Å—å –Ω–µ—Ç –¥–∞–∂–µ –ø–æ–ø—ã—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ

3. **Writing Sync**:
   - –§—Ä–æ–Ω—Ç–µ–Ω–¥ –≤—ã–∑—ã–≤–∞–µ—Ç `PATCH /writing-sessions/${sessionId}/sync/`, –Ω–æ —Ç–∞–∫–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ **–Ω–µ—Ç** –≤ `urls.py`
   - **–§–∞–∫—Ç**: –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 404, —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –∂–∏–≤—É—Ç —Ç–æ–ª—å–∫–æ –≤ `localStorage`

**–ü–æ—á–µ–º—É –±–∞–≥ –ø—Ä–æ—è–≤–ª—è–µ—Ç—Å—è —É ~20% —É—á–µ–Ω–∏–∫–æ–≤:**
- –£ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ `answersRef.current` –∏ `answers` (state) —Å–æ–¥–µ—Ä–∂–∞—Ç –¥–∞–Ω–Ω—ã–µ –≤ –º–æ–º–µ–Ω—Ç submit ‚Üí payload –Ω–µ –ø—É—Å—Ç–æ–π ‚Üí –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
- –£ —á–∞—Å—Ç–∏ —É—á–µ–Ω–∏–∫–æ–≤ –∏–∑-–∑–∞ —Ä–µ–¥–∫–∏—Ö race conditions, –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞ `localStorage`, –∏–ª–∏ –ø–µ—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ `payloadAnswers` –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—É—Å—Ç—ã–º `{}` ‚Üí –±—ç–∫–µ–Ω–¥ —Å—Ç–∏—Ä–∞–µ—Ç –≤—Å–µ –æ—Ç–≤–µ—Ç—ã

**–ü–æ—á–µ–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ sync –Ω–µ —É—Å—Ç—Ä–∞–Ω–∏–ª–æ –ø—Ä–æ–±–ª–µ–º—É:**
- Sync —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –ø—É—Ç–∏
- –ù–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π submit **–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç** `session.answers` —Ç–µ–º, —á—Ç–æ –ø—Ä–∏—à–ª–æ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º –∑–∞–ø—Ä–æ—Å–µ
- –ï—Å–ª–∏ —ç—Ç–æ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å –ø—É—Å—Ç–æ–π/—á–∞—Å—Ç–∏—á–Ω—ã–π, –≤—Å–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ sync –¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è

### 7. –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –∫–æ—Ä–Ω–µ–≤–æ–π –ø—Ä–∏—á–∏–Ω—ã —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞

#### 7.1. Listening Submit ‚Äî –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –ø—Ä–æ–±–ª–µ–º—ã

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (`backend/core/views.py`, —Å—Ç—Ä–æ–∫–∞ 2483):**
```python
session.answers = submit_serializer.validated_data.get('answers', session.answers)
```

**–ê–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è:**
1. `ListeningTestSessionSubmitSerializer` (`backend/core/serializers.py`, —Å—Ç—Ä–æ–∫–∏ 2259-2263):
   - –ü–æ–ª—è: `['answers', 'flagged', 'time_left', 'submitted']`
   - `answers` ‚Äî —ç—Ç–æ `JSONField` –∏–∑ –º–æ–¥–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–π **–Ω–µ –∏–º–µ–µ—Ç `required=False`** –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
   - –ü—Ä–∏ `partial=True` —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä **–ø—Ä–∏–Ω–∏–º–∞–µ—Ç** `answers` –∏–∑ `request.data`, –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –ø—É—Å—Ç–æ–π `{}`

2. –ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `{ answers: {} }`:
   - `submit_serializer.validated_data.get('answers')` –≤–µ—Ä–Ω—ë—Ç `{}` (–ø—É—Å—Ç–æ–π dict)
   - `submit_serializer.validated_data.get('answers', session.answers)` –≤–µ—Ä–Ω—ë—Ç `{}`, **–Ω–µ** `session.answers`
   - **–†–µ–∑—É–ª—å—Ç–∞—Ç**: `session.answers = {}` ‚Üí –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç—ë—Ä—Ç—ã

3. –ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `{ answers: { "123": "A" } }` (—á–∞—Å—Ç–∏—á–Ω—ã–π payload):
   - `submit_serializer.validated_data.get('answers')` –≤–µ—Ä–Ω—ë—Ç `{ "123": "A" }`
   - **–†–µ–∑—É–ª—å—Ç–∞—Ç**: `session.answers = { "123": "A" }` ‚Üí –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ —Å—Ç—ë—Ä—Ç—ã

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ —á–µ—Ä–µ–∑ –∫–æ–¥ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:**
- `ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∞ 489: `const payloadAnswers = answersRef.current || answers;`
- –ï—Å–ª–∏ `answersRef.current = {}` (–ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç, –Ω–æ –Ω–µ `null`/`undefined`), —Ç–æ `answersRef.current || answers` –≤–µ—Ä–Ω—ë—Ç `{}`
- –ï—Å–ª–∏ `answersRef.current = undefined` –∏ `answers = {}`, —Ç–æ —Ç–æ–∂–µ –≤–µ—Ä–Ω—ë—Ç—Å—è `{}`
- **–í—ã–≤–æ–¥**: –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ **–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ** –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø—É—Å—Ç–æ–π `{}`

#### 7.2. Reading Submit ‚Äî –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –ø—Ä–æ–±–ª–µ–º—ã

**–¢–µ–∫—É—â–∏–π –∫–æ–¥ (`backend/core/views.py`, —Å—Ç—Ä–æ–∫–∞ 3344):**
```python
answers_data = request.data.get('answers', {})
session.answers = answers_data
```

**–ê–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è:**
1. –ù–µ—Ç —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ ‚Äî –ø—Ä—è–º–∞—è —Ä–∞–±–æ—Ç–∞ —Å `request.data`
2. –ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `{ answers: {} }`:
   - `request.data.get('answers', {})` –≤–µ—Ä–Ω—ë—Ç `{}`
   - **–†–µ–∑—É–ª—å—Ç–∞—Ç**: `session.answers = {}` ‚Üí –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç—ë—Ä—Ç—ã **–±–µ–∑ fallback**

3. –ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `{ answers: { "456": "B" } }` (—á–∞—Å—Ç–∏—á–Ω—ã–π payload):
   - `request.data.get('answers', {})` –≤–µ—Ä–Ω—ë—Ç `{ "456": "B" }`
   - **–†–µ–∑—É–ª—å—Ç–∞—Ç**: `session.answers = { "456": "B" }` ‚Üí –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ —Å—Ç—ë—Ä—Ç—ã

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ —á–µ—Ä–µ–∑ –∫–æ–¥ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:**
- `ReadingTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∞ 404: `let payloadAnswers = answersRef.current || answers || {};`
- –ï—Å–ª–∏ –æ–±–∞ –ø—É—Å—Ç—ã–µ, —è–≤–Ω—ã–π fallback `|| {}` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –ø—É—Å—Ç–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
- **–í—ã–≤–æ–¥**: Reading **–∫—Ä–∏—Ç–∏—á–Ω–µ–µ**, —á–µ–º Listening ‚Äî –∑–¥–µ—Å—å –Ω–µ—Ç –¥–∞–∂–µ –ø–æ–ø—ã—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ

#### 7.3. –ö–æ–≥–¥–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø—É—Å—Ç–æ–π payload (–¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑)

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è + –ø—É—Å—Ç–æ–π localStorage (`ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∏ 103-149):**
```javascript
let serverAnswers = response.data.answers || {};  // –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è ‚Üí {}
let cachedAnswers = {};  // localStorage –ø—É—Å—Ç–æ–π ‚Üí {}
const mergedAnswers = { ...serverAnswers };  // mergedAnswers = {}
// ...
answersRef.current = mergedAnswers;  // answersRef.current = {}
setAnswers(mergedAnswers);  // answers = {}
```
- –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è, —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—ë—Ç `answers: {}` –∏–ª–∏ `null`
- –ï—Å–ª–∏ `localStorage` –ø—É—Å—Ç–æ–π (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫, –æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞), `cachedAnswers = {}`
- `mergedAnswers = {}` ‚Üí –æ–±–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—É—Å—Ç—ã–µ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: `answersRef.current = {}`, `answers = {}` ‚Üí –ø—Ä–∏ submit –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è `{}`

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ localStorage (`ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∏ 128-130):**
```javascript
try {
  const cached = localStorage.getItem(localCacheKeyRef.current);
  if (cached) {
    const parsed = JSON.parse(cached);  // ‚ö†Ô∏è –ú–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å
    // ...
  }
} catch (e) {
  console.warn('‚ö†Ô∏è Failed to parse localStorage cache:', e);
  // –ù–û: cachedAnswers –æ—Å—Ç–∞—ë—Ç—Å—è {} (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å—Ç—Ä–æ–∫–µ 105)
}
```
- –ï—Å–ª–∏ `JSON.parse` –ø–∞–¥–∞–µ—Ç (–ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–π JSON), `cachedAnswers = {}` (–Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è)
- `mergedAnswers` –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ `serverAnswers` (—Å—Ç—Ä–æ–∫–∞ 134)
- –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç—ã–µ `answers` (–Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä—è–ª–∏—Å—å), —Ç–æ `mergedAnswers = {}`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: `answersRef.current = {}` ‚Üí –ø—Ä–∏ submit –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è `{}`

**–°—Ü–µ–Ω–∞—Ä–∏–π 3: loadSession –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç answersRef (`ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∞ 218):**
```javascript
const loadSession = async (sessionId) => {
  // ...
  setAnswers(response.data.answers || {});  // ‚ö†Ô∏è –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ state
  // –ù–û: answersRef.current –ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è!
}
```
- –ï—Å–ª–∏ `loadSession` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ `startSession`, –æ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ `answers` (state)
- `answersRef.current` –æ—Å—Ç–∞—ë—Ç—Å—è —Å—Ç–∞—Ä—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º (–≤–æ–∑–º–æ–∂–Ω–æ –ø—É—Å—Ç—ã–º)
- –í `submitTest`: `const payloadAnswers = answersRef.current || answers`
- –ï—Å–ª–∏ `answersRef.current = {}` (—Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ), –∞ `answers` —Ç–æ–∂–µ –ø—É—Å—Ç–æ–π ‚Üí payload –±—É–¥–µ—Ç `{}`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ø—É—Å—Ç–æ–π payload –¥–∞–∂–µ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–°—Ü–µ–Ω–∞—Ä–∏–π 4: –ü–µ—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:**
- React –ø–µ—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–ª –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (–æ—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞, –Ω–∞–≤–∏–≥–∞—Ü–∏—è, Firebase —Ä–µ–¥–∏—Ä–µ–∫—Ç)
- `useState({})` —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç `answers = {}`
- `useRef({})` —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç `answersRef.current = {}`
- `useEffect` –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ localStorage –º–æ–∂–µ—Ç –Ω–µ —É—Å–ø–µ—Ç—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –¥–æ submit
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: `answersRef.current = {}`, `answers = {}` ‚Üí –ø—É—Å—Ç–æ–π payload

**–°—Ü–µ–Ω–∞—Ä–∏–π 5: loadSession –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç answersRef (–ö–†–ò–¢–ò–ß–ù–û!):**
```javascript
const loadSession = async (sessionId) => {
  // ...
  setAnswers(response.data.answers || {});  // ‚ö†Ô∏è –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ state
  // –ù–û: answersRef.current –ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è!
}
```
- –ï—Å–ª–∏ `loadSession` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏), –æ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ `answers` (state)
- `answersRef.current` –æ—Å—Ç–∞—ë—Ç—Å—è —Å—Ç–∞—Ä—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º (–≤–æ–∑–º–æ–∂–Ω–æ –ø—É—Å—Ç—ã–º `{}`)
- –í `submitTest`: `const payloadAnswers = answersRef.current || answers`
- –ï—Å–ª–∏ `answersRef.current = {}` (—Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ), –∞ `answers` —Ç–æ–∂–µ –ø—É—Å—Ç–æ–π ‚Üí payload –±—É–¥–µ—Ç `{}`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ø—É—Å—Ç–æ–π payload –¥–∞–∂–µ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ state

**–°—Ü–µ–Ω–∞—Ä–∏–π 6: Race condition –º–µ–∂–¥—É sync –∏ submit:**
- `submitTest` (—Å—Ç—Ä–æ–∫–∞ 488): `await syncAnswers();`
- `syncAnswers` (—Å—Ç—Ä–æ–∫–∞ 232): –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –æ–±–Ω–æ–≤–ª—è–µ—Ç `answersRef.current`
- –ï—Å–ª–∏ –º–µ–∂–¥—É `syncAnswers()` –∏ —á—Ç–µ–Ω–∏–µ–º `answersRef.current` (—Å—Ç—Ä–æ–∫–∞ 489) –ø—Ä–æ–∏–∑–æ—à—ë–ª —Ä–µ–¥–∫–∏–π —Å–±–æ–π/–ø–µ—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞, `answersRef.current` –º–æ–∂–µ—Ç –±—ã—Ç—å `undefined` –∏–ª–∏ `{}`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: `payloadAnswers = {}` ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—É—Å—Ç–æ–≥–æ payload

**–°—Ü–µ–Ω–∞—Ä–∏–π 7: –ü–µ—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:**
- –ï—Å–ª–∏ React –ø–µ—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–ª –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞), `answersRef.current` —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è
- `useEffect` –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ `localStorage` –º–æ–∂–µ—Ç –Ω–µ —É—Å–ø–µ—Ç—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –¥–æ submit
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: `answersRef.current = undefined`, `answers = {}` ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—É—Å—Ç–æ–≥–æ payload

#### 7.4. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π (sync endpoints)

**Listening Sync (`backend/core/views.py`, —Å—Ç—Ä–æ–∫–∏ 2544-2552):**
```python
if isinstance(answers_data, dict):
    for question_id, answer_value in answers_data.items():
        if isinstance(answer_value, dict) and question_id in session.answers and isinstance(session.answers[question_id], dict):
            session.answers[question_id].update(answer_value)  # –ú–ï–†–î–ñ
        else:
            session.answers[question_id] = answer_value  # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —ç—Ç–æ–≥–æ –∫–ª—é—á–∞
```
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ**: –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç

**Reading Sync (`backend/core/views.py`, —Å—Ç—Ä–æ–∫–∏ 3376-3384):**
```python
if isinstance(answers_data, dict):
    for question_id, answer_value in answers_data.items():
        if isinstance(answer_value, dict) and question_id in session.answers and isinstance(session.answers[question_id], dict):
            session.answers[question_id].update(answer_value)  # –ú–ï–†–î–ñ
        else:
            session.answers[question_id] = answer_value  # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —ç—Ç–æ–≥–æ –∫–ª—é—á–∞
```
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ**: –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç

**–í—ã–≤–æ–¥**: Sync-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã **–¥–æ–∫–∞–∑–∞–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã** —á–µ—Ä–µ–∑ –∫–æ–¥. Submit-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã **–¥–æ–∫–∞–∑–∞–Ω–æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã** —á–µ—Ä–µ–∑ –∫–æ–¥.

#### 7.5. –ò—Ç–æ–≥–æ–≤–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –Ω–∞ 100% —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞:**

1. ‚úÖ **–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ**: 
   - –ï—Å–ª–∏ `payloadAnswers = {}` ‚Üí `session.answers = {}` (Listening/Reading)
   - –ï—Å–ª–∏ `payloadAnswers = { "123": "A" }` ‚Üí `session.answers = { "123": "A" }` (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ —Å—Ç—ë—Ä—Ç—ã)

2. ‚úÖ **–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ —á–µ—Ä–µ–∑ –∫–æ–¥ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞**:
   - –ï—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ localStorage, race condition, –ø–µ—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ), –∫–æ–≥–¥–∞ `payloadAnswers` –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –±—É–¥–µ—Ç –ø—É—Å—Ç—ã–º/—á–∞—Å—Ç–∏—á–Ω—ã–º

3. ‚úÖ **–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ —á–µ—Ä–µ–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ**:
   - Sync-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ä–¥–∂ (–∫–æ–¥ —Å—Ç—Ä–æ–∫ 2544-2552, 3376-3384)
   - Submit-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—É—é –∑–∞–º–µ–Ω—É (–∫–æ–¥ —Å—Ç—Ä–æ–∫ 2483, 3344)

4. ‚úÖ **–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ —á–µ—Ä–µ–∑ –∏—Å—Ç–æ—Ä–∏—é Git**:
   - –ü—Ä–æ–±–ª–µ–º–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞ —Å —Å–∞–º–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è `ListeningTestSessionView`/`ReadingTestSessionView` (–∫–æ–º–º–∏—Ç `68dc11f9`)
   - –°—Ç–∞—Ä—ã–π `SubmitListeningTestView` —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –º–µ—Ä–¥–∂–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**–í—ã–≤–æ–¥: –∫–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ ‚Äî –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–º–µ–Ω–∞ `session.answers` –≤ submit-—ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö –≤–º–µ—Å—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –º–µ—Ä–¥–∂–∞, –∫–∞–∫ –≤ sync-—ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö.**

#### 7.6. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö

**–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
1. –£—á–µ–Ω–∏–∫ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç—ã ‚Üí `handleAnswerChange` ‚Üí `answersRef.current` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è ‚Üí `syncAnswers()` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
2. Sync —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç—ã –≤ `session.answers` –Ω–∞ –±—ç–∫–µ (–º–µ—Ä–¥–∂ —Ä–∞–±–æ—Ç–∞–µ—Ç)
3. –£—á–µ–Ω–∏–∫ –Ω–∞–∂–∏–º–∞–µ—Ç Submit ‚Üí `submitTest()` ‚Üí `payloadAnswers = answersRef.current || answers` ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
4. **–ü—Ä–æ–±–ª–µ–º–∞**: –µ—Å–ª–∏ –Ω–∞ —à–∞–≥–µ 3 `answersRef.current = {}`, —Ç–æ –±—ç–∫–µ–Ω–¥ **—Å—Ç–∏—Ä–∞–µ—Ç** –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —à–∞–≥–∞ 2

**–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏:**
1. –£—á–µ–Ω–∏–∫ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç—ã ‚Üí `handleAnswerChange` ‚Üí `answersRef.current` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
2. –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ `localStorage` (—Å—Ç—Ä–æ–∫–∞ 128-130) ‚Üí `cachedAnswers = {}`
3. `mergedAnswers = { ...serverAnswers }` (—Å—Ç—Ä–æ–∫–∞ 134) ‚Üí –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç—ã–µ `answers`, —Ç–æ `mergedAnswers = {}`
4. `answersRef.current = {}` (—Å—Ç—Ä–æ–∫–∞ 149)
5. –£—á–µ–Ω–∏–∫ –Ω–∞–∂–∏–º–∞–µ—Ç Submit ‚Üí `payloadAnswers = {} || {}` ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ `{ answers: {} }`
6. –ë—ç–∫–µ–Ω–¥: `session.answers = {}` ‚Üí **–≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å—Ç—ë—Ä—Ç—ã**

**–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ —á–µ—Ä–µ–∑ –∫–æ–¥:**
- –í `ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∞ 489: `const payloadAnswers = answersRef.current || answers;`
- –ï—Å–ª–∏ `answersRef.current = {}` (–ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç), —Ç–æ `{} || answers` –≤–µ—Ä–Ω—ë—Ç `{}` (–Ω–µ `answers`)
- JavaScript: `{}` ‚Äî —ç—Ç–æ truthy –∑–Ω–∞—á–µ–Ω–∏–µ, –ø–æ—ç—Ç–æ–º—É `||` –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
- **–í—ã–≤–æ–¥**: –ø—Ä–∏ `answersRef.current = {}` —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ **–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ** –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø—É—Å—Ç–æ–π payload

**–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è Reading:**
- –í `ReadingTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∞ 404: `let payloadAnswers = answersRef.current || answers || {};`
- –ï—Å–ª–∏ –æ–±–∞ –ø—É—Å—Ç—ã–µ, —è–≤–Ω—ã–π fallback `|| {}` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –ø—É—Å—Ç–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
- **–í—ã–≤–æ–¥**: Reading –µ—â—ë –±–æ–ª–µ–µ —É—è–∑–≤–∏–º, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–∞–∂–µ –ø—Ä–∏ `answersRef.current = undefined` –∏ `answers = undefined` –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è `{}`

**–ò—Ç–æ–≥–æ–≤–æ–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ:**
1. ‚úÖ –ö–æ–¥ –±—ç–∫–µ–Ω–¥–∞ **–¥–æ–∫–∞–∑–∞–Ω–æ** –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç `session.answers` –±–µ–∑ –º–µ—Ä–¥–∂–∞ (—Å—Ç—Ä–æ–∫–∏ 2483, 3344)
2. ‚úÖ –ö–æ–¥ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ **–¥–æ–∫–∞–∑–∞–Ω–æ** –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–π `{}` –≤ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö (—Å—Ç—Ä–æ–∫–∏ 489, 404)
3. ‚úÖ –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏: –ø—É—Å—Ç–æ–π `{}` –≤ JavaScript ‚Äî —ç—Ç–æ truthy, –ø–æ—ç—Ç–æ–º—É `||` –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ fallback
4. ‚úÖ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å sync: sync –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ä–¥–∂, submit ‚Äî –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—É—é –∑–∞–º–µ–Ω—É

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –Ω–∞ 100% —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.**

---

## 8. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø–æ—Ç–µ—Ä–µ–π –¥–∞–Ω–Ω—ã—Ö

### 8.1. –í–Ω–µ–∑–∞–ø–Ω—ã–π —Ä–µ—Å—Ç–∞—Ä—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)

#### –ü—Ä–æ–±–ª–µ–º–∞ 1: Firebase onIdTokenChanged ‚Äî –∂–µ—Å—Ç–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç

**–ö–æ–¥:** `frontend/src/firebase.js`, —Å—Ç—Ä–æ–∫–∏ 19-53

```javascript
onIdTokenChanged(auth, async (user) => {
  if (user) {
    // ... —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
  } else {
    setTimeout(async () => {
      if (auth.currentUser) {
        // ... –ø–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω
      }
      localStorage.removeItem('token');
      // ... —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
      const publicPaths = ['/login', '/Ptest'];
      if (!publicPaths.includes(window.location.pathname)) {
        window.location.href = '/login';  // ‚ö†Ô∏è –ñ–ï–°–¢–ö–ò–ô –†–ï–î–ò–†–ï–ö–¢
      }
    }, 1500);
  }
});
```

**–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã:**
1. –ï—Å–ª–∏ Firebase —Ç–µ—Ä—è–µ—Ç —Å–µ—Å—Å–∏—é (–∏—Å—Ç–µ—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞, —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞, –ø—Ä–æ–±–ª–µ–º–∞ —Å Firebase —Å–µ—Ä–≤–µ—Ä–æ–º), `user` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `null`
2. –ß–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–∂–µ—Å—Ç–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç** `window.location.href = '/login'`
3. –≠—Ç–æ **–ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã** ‚Äî –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ React —Ç–µ—Ä—è–µ—Ç—Å—è
4. `localStorage` –æ—á–∏—â–∞–µ—Ç—Å—è **–¥–æ** —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞, –ø–æ—ç—Ç–æ–º—É –¥–∞–∂–µ –∫–µ—à –æ—Ç–≤–µ—Ç–æ–≤ —Ç–µ—Ä—è–µ—Ç—Å—è

**–ö–æ–≥–¥–∞ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ò—Å—Ç–µ—á–µ–Ω–∏–µ Firebase —Ç–æ–∫–µ–Ω–∞ –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞ (–æ–±—ã—á–Ω–æ —á–µ—Ä–µ–∑ 1 —á–∞—Å)
- –°–µ—Ç–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞
- –ü—Ä–æ–±–ª–µ–º—ã –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ Firebase —Å–µ—Ä–≤–µ—Ä–æ–≤
- –ú–æ–±–∏–ª—å–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã –º–æ–≥—É—Ç –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ –≤—ã–≥—Ä—É–∂–∞—Ç—å –≤–∫–ª–∞–¥–∫–∏ –∏–∑ –ø–∞–º—è—Ç–∏, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–æ—Ç–µ—Ä–µ Firebase —Å–µ—Å—Å–∏–∏

**–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ —á–µ—Ä–µ–∑ –∫–æ–¥:**
- `window.location.href` ‚Äî —ç—Ç–æ **–Ω–µ** React Router `navigate()`, —ç—Ç–æ –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- –í—Å–µ React —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ—Ä—è–µ—Ç—Å—è, –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä—É—é—Ç—Å—è
- `localStorage` –æ—á–∏—â–∞–µ—Ç—Å—è **–¥–æ** —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ (—Å—Ç—Ä–æ–∫–∏ 39-45), –ø–æ—ç—Ç–æ–º—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ

#### –ü—Ä–æ–±–ª–µ–º–∞ 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ 401/403 –≤ submitTest ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—è –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞

**–ö–æ–¥ Listening:** `frontend/src/components/ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∏ 511-518
```javascript
catch (err) {
  if (err.response && (err.response.status === 401 || err.response.status === 403)) {
    setError('Session expired, please login again.');
    setTimeout(() => navigate('/login'), 1500);  // ‚ö†Ô∏è –ù–ê–í–ò–ì–ê–¶–ò–Ø
  } else {
    setError('Failed to submit test');
  }
}
```

**–ö–æ–¥ Reading:** `frontend/src/components/ReadingTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∏ 458-465
```javascript
catch (err) {
  if (err.response && (err.response.status === 401 || err.response.status === 403)) {
    setError('Session expired, please login again.');
    setTimeout(() => navigate('/login'), 1500);  // ‚ö†Ô∏è –ù–ê–í–ò–ì–ê–¶–ò–Ø
  } else {
    console.error('üî• ERROR submitting test:', err.response?.data || err);
    alert('Failed to submit test. Please try again.');
  }
}
```

**–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã:**
1. –ï—Å–ª–∏ submit –ø–∞–¥–∞–µ—Ç —Å 401/403 **–ø–æ—Å–ª–µ** —Ç–æ–≥–æ, –∫–∞–∫ –æ—Ç–≤–µ—Ç—ã –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –Ω–æ **–¥–æ** –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏—è
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞, —Ö–æ—Ç—è –¥–∞–Ω–Ω—ã–µ –º–æ–≥–ª–∏ –±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
3. –ï—Å–ª–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç **–¥–æ** —É—Å–ø–µ—à–Ω–æ–≥–æ submit, –æ—Ç–≤–µ—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω—ã (–µ—Å–ª–∏ –±—ç–∫–µ–Ω–¥ –Ω–µ —É—Å–ø–µ–ª —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å)

**Race condition:**
- `syncAnswers()` —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä (—Å—Ç—Ä–æ–∫–∞ 488/401)
- `submitTest()` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π submit (—Å—Ç—Ä–æ–∫–∞ 493/433)
- –ï—Å–ª–∏ submit –ø–∞–¥–∞–µ—Ç —Å 401/403, –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏—è
- –ù–æ –æ—Ç–≤–µ—Ç—ã —É–∂–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —á–µ—Ä–µ–∑ sync ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç

#### –ü—Ä–æ–±–ª–µ–º–∞ 3: –£–¥–∞–ª–µ–Ω–∏–µ localStorage –ø–µ—Ä–µ–¥ –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π

**–ö–æ–¥ Listening:** `frontend/src/components/ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∏ 503-509
```javascript
if (localCacheKeyRef.current) {
  localStorage.removeItem(localCacheKeyRef.current);  // ‚ö†Ô∏è –£–î–ê–õ–ï–ù–ò–ï –ü–ï–†–ï–î –ù–ê–í–ò–ì–ê–¶–ò–ï–ô
}
if (syncTimerRef.current) {
  clearTimeout(syncTimerRef.current);
}
navigate(`/listening-result/${session.id}`);
```

**–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã:**
1. `localStorage.removeItem()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **–¥–æ** `navigate()`
2. –ï—Å–ª–∏ `navigate()` –ø–∞–¥–∞–µ—Ç –∏–ª–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ—à–∏–±–∫–∞, –∫–µ—à —É–∂–µ —É–¥–∞–ª—ë–Ω
3. –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–µ—Å—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ

**–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è Reading:** —Å—Ç—Ä–æ–∫–∏ 447-456

### 8.2. Race condition –≤ auto-submit

#### –ü—Ä–æ–±–ª–µ–º–∞ 4: Race condition –º–µ–∂–¥—É sync –∏ submit –≤ auto-submit

**–ö–æ–¥ Listening:** `frontend/src/components/ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∏ 285-298
```javascript
(async () => {
  try {
    const currentAnswers = answersRef.current || {};
    const currentFlagged = flaggedRef.current || {};
    const remaining = 0;
    await api.patch(`/listening-sessions/${session.id}/sync/`, { answers: currentAnswers, flagged: currentFlagged, time_left: remaining });
  } catch (err) {
    console.error('‚ùå Failed to sync before auto-submit:', err);
  }
  
  // ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: –º–µ–∂–¥—É sync –∏ submit –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ answersRef.current
  try {
    const payloadAnswers = answersRef.current || {};  // ‚ö†Ô∏è –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–æ –ø–µ—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    await api.post(`/listening-sessions/${session.id}/submit/`, { answers: payloadAnswers, time_left: 0 });
    // ...
  } catch (err) {
    // ...
  }
})();
```

**–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã:**
1. `sync` —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `currentAnswers` –Ω–∞ —Å–µ—Ä–≤–µ—Ä
2. –ú–µ–∂–¥—É `sync` –∏ —á—Ç–µ–Ω–∏–µ–º `answersRef.current` (—Å—Ç—Ä–æ–∫–∞ 298) –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏:
   - –ü–µ—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ ‚Üí `answersRef.current = undefined`
   - –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ localStorage ‚Üí `answersRef.current = {}`
   - Race condition —Å –¥—Ä—É–≥–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
3. `payloadAnswers` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø—É—Å—Ç—ã–º `{}`
4. Submit –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—É—Å—Ç–æ–π payload ‚Üí –±—ç–∫–µ–Ω–¥ —Å—Ç–∏—Ä–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ

**–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è Reading:** —Å—Ç—Ä–æ–∫–∏ 96-132

### 8.3. –ü—Ä–æ–±–ª–µ–º—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫

#### –ü—Ä–æ–±–ª–µ–º–∞ 5: Retry –ª–æ–≥–∏–∫–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç payload

**–ö–æ–¥ Listening:** `frontend/src/components/ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∏ 492-502
```javascript
try {
  response = await api.post(`/listening-sessions/${session.id}/submit/`, { answers: payloadAnswers, time_left: remaining });
} catch (err) {
  if (err.response && (err.response.status === 401 || err.response.status === 403) && auth.currentUser) {
    await auth.currentUser.getIdToken(true);
    response = await api.post(`/listening-sessions/${session.id}/submit/`, { answers: payloadAnswers, time_left: remaining });
  } else {
    throw err;
  }
}
```

**–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã:**
1. –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø–∞–¥–∞–µ—Ç —Å 401/403, –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç retry
2. –ù–æ –º–µ–∂–¥—É –ø–µ—Ä–≤—ã–º –∏ –≤—Ç–æ—Ä—ã–º –∑–∞–ø—Ä–æ—Å–æ–º `payloadAnswers` **–Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è**
3. –ï—Å–ª–∏ –∑–∞ —ç—Ç–æ –≤—Ä–µ–º—è `answersRef.current` –∏–∑–º–µ–Ω–∏–ª—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ–ª –∏–∑–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç), retry –æ—Ç–ø—Ä–∞–≤–∏—Ç **—Å—Ç–∞—Ä—ã–π** payload
4. –ù–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ—Ä—è—é—Ç—Å—è

**–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è Reading:** —Å—Ç—Ä–æ–∫–∏ 432-446

#### –ü—Ä–æ–±–ª–µ–º–∞ 6: –ì–ª–æ–±–∞–ª—å–Ω—ã–π API interceptor –º–æ–∂–µ—Ç —Å–∫—Ä—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏

**–ö–æ–¥:** `frontend/src/api.js`, —Å—Ç—Ä–æ–∫–∏ 52-74
```javascript
api.interceptors.response.use(
  (response) => response,
  async (error) => {
    const originalRequest = error.config;
    if (!originalRequest || originalRequest._retry) {
      return Promise.reject(error);
    }
    const status = error.response?.status;
    if ((status === 401 || status === 403) && auth?.currentUser) {
      originalRequest._retry = true;
      try {
        const newToken = await auth.currentUser.getIdToken(true);
        originalRequest.headers = originalRequest.headers || {};
        originalRequest.headers['Authorization'] = `Bearer ${newToken}`;
        return api(originalRequest);  // ‚ö†Ô∏è –†–ï–¢–†–ê–ô –° –¢–ï–ú –ñ–ï PAYLOAD
      } catch (refreshErr) {
        return Promise.reject(refreshErr);
      }
    }
    return Promise.reject(error);
  }
);
```

**–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã:**
1. Interceptor –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ª–∞–µ—Ç retry –ø—Ä–∏ 401/403
2. Retry –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **—Ç–æ—Ç –∂–µ** `originalRequest`, –≤–∫–ª—é—á–∞—è **—Ç–æ—Ç –∂–µ payload**
3. –ï—Å–ª–∏ payload –±—ã–ª –ø—É—Å—Ç—ã–º/—á–∞—Å—Ç–∏—á–Ω—ã–º, retry –æ—Ç–ø—Ä–∞–≤–∏—Ç **—Ç–æ—Ç –∂–µ** –ø—É—Å—Ç–æ–π/—á–∞—Å—Ç–∏—á–Ω—ã–π payload
4. –û—à–∏–±–∫–∞ –Ω–µ –≤–∏–¥–Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É, –ø–æ—Ç–æ–º—É —á—Ç–æ interceptor "–ø–æ–≥–ª–æ—â–∞–µ—Ç" –µ—ë

### 8.4. –ò—Ç–æ–≥–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–æ–±–ª–µ–º

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (–ø—Ä–∏–≤–æ–¥—è—Ç –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö):**

1. ‚úÖ **–ü—É—Å—Ç–æ–π payload –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ** (—Ä–∞–∑–¥–µ–ª 7.3):
   - –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è + –ø—É—Å—Ç–æ–π localStorage ‚Üí `answersRef.current = {}`
   - –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ localStorage ‚Üí `cachedAnswers = {}` ‚Üí `mergedAnswers = {}`
   - **loadSession –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç answersRef** ‚Üí `answersRef.current` –æ—Å—Ç–∞—ë—Ç—Å—è —Å—Ç–∞—Ä—ã–º (–≤–æ–∑–º–æ–∂–Ω–æ –ø—É—Å—Ç—ã–º)
   - –ü–µ—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ ‚Üí state –∏ ref —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è
   - Race conditions –º–µ–∂–¥—É sync –∏ submit

2. ‚úÖ **Submit endpoints –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç `session.answers` –±–µ–∑ –º–µ—Ä–¥–∂–∞** (—Ä–∞–∑–¥–µ–ª 6):
   - –î–∞–∂–µ –µ—Å–ª–∏ payload –ø—É—Å—Ç–æ–π, –±—ç–∫–µ–Ω–¥ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
   - –ï—Å–ª–∏ –±—ã –±—ã–ª –º–µ—Ä–¥–∂, –ø—É—Å—Ç–æ–π payload –Ω–µ —Å—Ç—ë—Ä –±—ã —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ

3. ‚úÖ **Firebase onIdTokenChanged ‚Äî –∂–µ—Å—Ç–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å –æ—á–∏—Å—Ç–∫–æ–π localStorage** (—Ä–∞–∑–¥–µ–ª 8.1, –ø—Ä–æ–±–ª–µ–º–∞ 1)

4. ‚úÖ **Race condition –≤ auto-submit –º–µ–∂–¥—É sync –∏ submit** (—Ä–∞–∑–¥–µ–ª 8.2, –ø—Ä–æ–±–ª–µ–º–∞ 4)

5. ‚úÖ **–£–¥–∞–ª–µ–Ω–∏–µ localStorage –ø–µ—Ä–µ–¥ –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π** (—Ä–∞–∑–¥–µ–ª 8.1, –ø—Ä–æ–±–ª–µ–º–∞ 3)

**–°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (–º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–¥–∫–∏—Ö —Å–ª—É—á–∞—è—Ö):**
5. ‚ö†Ô∏è **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ 401/403 ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—è –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞** (—Ä–∞–∑–¥–µ–ª 8.1, –ø—Ä–æ–±–ª–µ–º–∞ 2)
6. ‚ö†Ô∏è **Retry –ª–æ–≥–∏–∫–∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç payload** (—Ä–∞–∑–¥–µ–ª 8.3, –ø—Ä–æ–±–ª–µ–º–∞ 5)
7. ‚ö†Ô∏è **–ì–ª–æ–±–∞–ª—å–Ω—ã–π API interceptor —Å–∫—Ä—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏** (—Ä–∞–∑–¥–µ–ª 8.3, –ø—Ä–æ–±–ª–µ–º–∞ 6)

**–ü–æ—á–µ–º—É –ø—Ä–æ–±–ª–µ–º—ã –ø–æ—è–≤–∏–ª–∏—Å—å "–≤–Ω–µ–∑–∞–ø–Ω–æ":**
1. **–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –±—ã–ª–∞ –≤—Å–µ–≥–¥–∞**: –ë—ç–∫–µ–Ω–¥ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç `session.answers` –≤–º–µ—Å—Ç–æ –º–µ—Ä–¥–∂–∞
   - –î–æ sync: React state `answers` –º–æ–≥ –±—ã—Ç—å –ø—É—Å—Ç—ã–º ‚Üí –ø—É—Å—Ç–æ–π payload ‚Üí –¥–∞–Ω–Ω—ã–µ —Å—Ç–∏—Ä–∞–ª–∏—Å—å
   - –ü–æ—Å–ª–µ sync: `answersRef.current` –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º ‚Üí –ø—É—Å—Ç–æ–π payload ‚Üí –¥–∞–Ω–Ω—ã–µ —Å—Ç–∏—Ä–∞—é—Ç—Å—è
   - Sync –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ –ø–æ–ø—ã—Ç–∫–∞ —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É, –Ω–æ –Ω–µ —Ä–µ—à–∏–ª, –ø–æ—Ç–æ–º—É —á—Ç–æ submit –≤—Å—ë –µ—â—ë –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç
2. **–ü–æ—á–µ–º—É –ø—Ä–æ–±–ª–µ–º–∞ —Å—Ç–∞–ª–∞ –ø—Ä–æ—è–≤–ª—è—Ç—å—Å—è —á–∞—â–µ "–≤–Ω–µ–∑–∞–ø–Ω–æ"**:
   - Firebase —Ç–æ–∫–µ–Ω—ã —Å—Ç–∞–ª–∏ –∏—Å—Ç–µ–∫–∞—Ç—å —á–∞—â–µ ‚Üí –±–æ–ª—å—à–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤ ‚Üí –±–æ–ª—å—à–µ –ø–µ—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–π ‚Üí state/ref —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è
   - –ú–æ–±–∏–ª—å–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã —Å—Ç–∞–ª–∏ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–µ–µ –≤—ã–≥—Ä—É–∂–∞—Ç—å –≤–∫–ª–∞–¥–∫–∏ ‚Üí –±–æ–ª—å—à–µ –ø–µ—Ä–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–π ‚Üí state/ref —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è
   - –°–µ—Ç–µ–≤—ã–µ —É—Å–ª–æ–≤–∏—è —É—Ö—É–¥—à–∏–ª–∏—Å—å ‚Üí –±–æ–ª—å—à–µ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ state/ref ‚Üí –±–æ–ª—å—à–µ –ø—É—Å—Ç—ã—Ö payload
   - –£–≤–µ–ª–∏—á–∏–ª–∞—Å—å –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä ‚Üí –±–æ–ª—å—à–µ race conditions ‚Üí –±–æ–ª—å—à–µ —Å–ª—É—á–∞–µ–≤ –ø—É—Å—Ç–æ–≥–æ payload
   - –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è sync –ø–æ—è–≤–∏–ª–∞—Å—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç `answersRef.current`, —á—Ç–æ —É—Å—É–≥—É–±–∏–ª–æ –ø—Ä–æ–±–ª–µ–º—É
3. **–í—ã–≤–æ–¥**: –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤—Å–µ–≥–¥–∞, –Ω–æ —Å—Ç–∞–ª–∞ –ø—Ä–æ—è–≤–ª—è—Ç—å—Å—è —á–∞—â–µ –∏–∑-–∑–∞ –≤–Ω–µ—à–Ω–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤ + —É—Å—É–≥—É–±–∏–ª–∞—Å—å –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è sync

---

## 9. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º –∞—É–¥–∏—Ç–µ

### 9.1. Firebase –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

#### –ü—Ä–æ–±–ª–µ–º–∞ 8: Firebase onIdTokenChanged –æ—á–∏—â–∞–µ—Ç localStorage –î–û –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—É—Ç–∏

**–ö–æ–¥:** `frontend/src/firebase.js`, —Å—Ç—Ä–æ–∫–∏ 39-49
```javascript
localStorage.removeItem('token');
localStorage.removeItem('uid');
localStorage.removeItem('role');
localStorage.removeItem('student_id');
localStorage.removeItem('first_name');
localStorage.removeItem('last_name');
localStorage.removeItem('group');
// –ü—É–±–ª–∏—á–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ —Ç—Ä–µ–±—É—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
const publicPaths = ['/login', '/Ptest'];
if (!publicPaths.includes(window.location.pathname)) {
  window.location.href = '/login';
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `localStorage` –æ—á–∏—â–∞–µ—Ç—Å—è **–¥–æ** –ø—Ä–æ–≤–µ—Ä–∫–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø—É—Ç—å –ø—É–±–ª–∏—á–Ω—ã–º
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ç–µ—Å—Ç–∞ (`/listening-test/123`), localStorage –æ—á–∏—â–∞–µ—Ç—Å—è, –Ω–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç –º–æ–∂–µ—Ç –Ω–µ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ —Å—Ä–∞–∑—É
- –ö–µ—à –æ—Ç–≤–µ—Ç–æ–≤ —Ç–µ—Ä—è–µ—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–µ –ø—Ä–æ–∏–∑–æ—à—ë–ª

#### –ü—Ä–æ–±–ª–µ–º–∞ 9: API interceptor –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å Firebase

**–ö–æ–¥:** `frontend/src/api.js`, —Å—Ç—Ä–æ–∫–∏ 33-49
```javascript
api.interceptors.request.use(async (config) => {
  // ...
  if (!isPublicEndpoint) {
    await waitForAuth();  // ‚ö†Ô∏è –ú–æ–∂–µ—Ç –∑–∞–≤–∏—Å–Ω—É—Ç—å
    const user = auth.currentUser;
    if (user) {
      const token = await user.getIdToken();  // ‚ö†Ô∏è –ú–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å
      config.headers['Authorization'] = `Bearer ${token}`;
    }
  }
  return config;
}, (error) => Promise.reject(error));
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ `waitForAuth()` –∑–∞–≤–∏—Å–Ω–µ—Ç –∏–ª–∏ `getIdToken()` —É–ø–∞–¥—ë—Ç, –∑–∞–ø—Ä–æ—Å –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è
- Sync/submit –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É–≤–∏–¥–∏—Ç –æ—à–∏–±–∫—É
- –î–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ `localStorage`, –Ω–æ –Ω–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### 9.2. Writing –º–æ–¥—É–ª—å

#### –ü—Ä–æ–±–ª–µ–º–∞ 10: Writing —É–¥–∞–ª—è–µ—Ç localStorage –î–û —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ submit

**–ö–æ–¥:** `frontend/src/pages/WritingTaskPage.js`, —Å—Ç—Ä–æ–∫–∏ 179-183
```javascript
await withRetry(() => api.post('/finish-writing-session/', { session_id: sessionId }));

// Clear localStorage for this session
localStorage.removeItem(`writing_task1_${sessionId}`);
localStorage.removeItem(`writing_task2_${sessionId}`);
localStorage.removeItem(`writing_deadline_${sessionId}`);

navigate(`/writing/result/${sessionId}`);
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `localStorage` –æ—á–∏—â–∞–µ—Ç—Å—è **–ø–æ—Å–ª–µ** `finish-writing-session`, –Ω–æ **–¥–æ** `navigate`
- –ï—Å–ª–∏ `navigate` –ø–∞–¥–∞–µ—Ç –∏–ª–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ—à–∏–±–∫–∞, –∫–µ—à —É–∂–µ —É–¥–∞–ª—ë–Ω
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ—Ä–Ω—ë—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ

#### –ü—Ä–æ–±–ª–µ–º–∞ 11: Writing sync endpoint –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—É–∂–µ –Ω–∞–π–¥–µ–Ω–æ, –Ω–æ –≤–∞–∂–Ω–æ)

**–ö–æ–¥:** `frontend/src/pages/WritingTaskPage.js`, —Å—Ç—Ä–æ–∫–∞ 123
```javascript
await api.patch(`/writing-sessions/${sessionId}/sync/`, {
  task1_text: task1Text,
  task2_text: task2Text,
  time_left: Math.max(0, Math.round(timeRemaining)),
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 404
- –ß–µ—Ä–Ω–æ–≤–∏–∫–∏ –∂–∏–≤—É—Ç —Ç–æ–ª—å–∫–æ –≤ `localStorage`
- –ü—Ä–∏ –ø–æ—Ç–µ—Ä–µ `localStorage` (–¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —Ä–µ–∂–∏–º, –æ—á–∏—Å—Ç–∫–∞) —á–µ—Ä–Ω–æ–≤–∏–∫–∏ —Ç–µ—Ä—è—é—Ç—Å—è

### 9.3. App.js –∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

#### –ü—Ä–æ–±–ª–µ–º–∞ 12: App.js –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ localStorage –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

**–ö–æ–¥:** `frontend/src/App.js`, —Å—Ç—Ä–æ–∫–∏ 144-147
```javascript
const token = localStorage.getItem('token');
if (!token) {
  return;  // ‚ö†Ô∏è –ú–æ–ª—á–∞ –≤—ã—Ö–æ–¥–∏—Ç, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ —Å Firebase
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø—Ä–æ—Å–∞ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è
- –ù–æ –µ—Å–ª–∏ Firebase —Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫, `localStorage.getItem('token')` –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Ç–æ–∫–µ–Ω
- –ó–∞–ø—Ä–æ—Å –∫ `/api/teacher-survey/` –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å —Å 401, –Ω–æ –æ—à–∏–±–∫–∞ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è

### 9.4. –¢–∞–π–º–µ—Ä—ã –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

#### –ü—Ä–æ–±–ª–µ–º–∞ 13: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç–∞–π–º–µ—Ä—ã –±–µ–∑ –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–ö–æ–¥:** `frontend/src/components/ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∏ 467-473
```javascript
const scheduleSync = () => {
  if (!session) return;
  if (syncTimerRef.current) {
    clearTimeout(syncTimerRef.current);
  }
  syncTimerRef.current = setTimeout(syncAnswers, 800);
};
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ `syncAnswers` –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π, —Ç–∞–π–º–µ—Ä –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—á–∏—â–∞–µ—Ç—Å—è
- –ù–æ –µ—Å–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–ª—Å—è –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `syncAnswers`, —Ç–∞–π–º–µ—Ä –º–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º
- –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ–ø—ã—Ç–∫–µ sync –ø–æ—Å–ª–µ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞

#### –ü—Ä–æ–±–ª–µ–º–∞ 14: Auto-submit –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä—è–º—ã–µ –≤—ã–∑–æ–≤—ã API –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è

**–ö–æ–¥:** `frontend/src/components/ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∏ 285-313
```javascript
(async () => {
  try {
    await api.patch(`/listening-sessions/${session.id}/sync/`, { ... });
  } catch (err) {
    console.error('‚ùå Failed to sync before auto-submit:', err);
  }
  
  try {
    const payloadAnswers = answersRef.current || {};  // ‚ö†Ô∏è –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º
    await api.post(`/listening-sessions/${session.id}/submit/`, { answers: payloadAnswers, time_left: 0 });
    // ...
  } catch (err) {
    console.error('üî• ERROR auto-submitting test:', err.response?.data || err);
    alert('Failed to auto-submit test. Please submit manually.');
  }
})();
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ `sync` –ø–∞–¥–∞–µ—Ç, auto-submit –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è
- `payloadAnswers` –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ—Ç
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ alert, –Ω–æ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –ø–æ—Ç–µ—Ä—è–Ω—ã

### 9.5. Visibility change handlers

#### –ü—Ä–æ–±–ª–µ–º–∞ 15: Visibility change –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å sync —Å –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

**–ö–æ–¥:** `frontend/src/components/ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∏ 258-263
```javascript
const handleVisibilityChange = () => {
  if (document.hidden) {
    if (syncTimerRef.current) {
      clearTimeout(syncTimerRef.current);
    }
    syncAnswers();  // ‚ö†Ô∏è –ú–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω —Å –ø—É—Å—Ç—ã–º–∏ answersRef.current
  }
};
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–ª—Å—è –∏ `answersRef.current` –µ—â—ë –ø—É—Å—Ç–æ–π, sync –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø—É—Å—Ç–æ–π payload
- Sync –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–µ—Ä–¥–∂ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ, –ø–æ—ç—Ç–æ–º—É —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –±—ã–ª–∏ —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ

### 9.6. –ò—Ç–æ–≥–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –í–°–ï–• –ø—Ä–æ–±–ª–µ–º

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (–ø—Ä–∏–≤–æ–¥—è—Ç –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö):**
1. ‚úÖ –ü—É—Å—Ç–æ–π payload –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ (—Ä–∞–∑–¥–µ–ª 7.3)
2. ‚úÖ Submit endpoints –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç `session.answers` –±–µ–∑ –º–µ—Ä–¥–∂–∞ (—Ä–∞–∑–¥–µ–ª 6)
3. ‚úÖ Firebase onIdTokenChanged ‚Äî –∂–µ—Å—Ç–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å –æ—á–∏—Å—Ç–∫–æ–π localStorage (—Ä–∞–∑–¥–µ–ª 8.1)
4. ‚úÖ loadSession –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç answersRef (—Ä–∞–∑–¥–µ–ª 7.3, —Å—Ü–µ–Ω–∞—Ä–∏–π 3)
5. ‚úÖ Writing —É–¥–∞–ª—è–µ—Ç localStorage –î–û –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (—Ä–∞–∑–¥–µ–ª 9.2, –ø—Ä–æ–±–ª–µ–º–∞ 10)
6. ‚úÖ Writing sync endpoint –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—Ä–∞–∑–¥–µ–ª 9.2, –ø—Ä–æ–±–ª–µ–º–∞ 11)

**–°—Ä–µ–¥–Ω–∏–µ (–º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–¥–∫–∏—Ö —Å–ª—É—á–∞—è—Ö):**
7. ‚ö†Ô∏è Race condition –≤ auto-submit –º–µ–∂–¥—É sync –∏ submit (—Ä–∞–∑–¥–µ–ª 8.2)
8. ‚ö†Ô∏è –£–¥–∞–ª–µ–Ω–∏–µ localStorage –ø–µ—Ä–µ–¥ –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π (—Ä–∞–∑–¥–µ–ª 8.1, –ø—Ä–æ–±–ª–µ–º–∞ 3)
9. ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ 401/403 ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—è –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞ (—Ä–∞–∑–¥–µ–ª 8.1, –ø—Ä–æ–±–ª–µ–º–∞ 2)
10. ‚ö†Ô∏è Firebase –æ—á–∏—â–∞–µ—Ç localStorage –î–û –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—É—Ç–∏ (—Ä–∞–∑–¥–µ–ª 9.1, –ø—Ä–æ–±–ª–µ–º–∞ 8)
11. ‚ö†Ô∏è API interceptor –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã (—Ä–∞–∑–¥–µ–ª 9.1, –ø—Ä–æ–±–ª–µ–º–∞ 9)
12. ‚ö†Ô∏è Auto-submit –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ sync —É–ø–∞–ª (—Ä–∞–∑–¥–µ–ª 9.4, –ø—Ä–æ–±–ª–µ–º–∞ 14)

**–ù–∏–∑–∫–∏–µ (–º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã):**
13. ‚ö†Ô∏è Retry –ª–æ–≥–∏–∫–∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç payload (—Ä–∞–∑–¥–µ–ª 8.3, –ø—Ä–æ–±–ª–µ–º–∞ 5)
14. ‚ö†Ô∏è –ì–ª–æ–±–∞–ª—å–Ω—ã–π API interceptor —Å–∫—Ä—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ (—Ä–∞–∑–¥–µ–ª 8.3, –ø—Ä–æ–±–ª–µ–º–∞ 6)
15. ‚ö†Ô∏è –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç–∞–π–º–µ—Ä—ã –±–µ–∑ –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (—Ä–∞–∑–¥–µ–ª 9.4, –ø—Ä–æ–±–ª–µ–º–∞ 13)
16. ‚ö†Ô∏è Visibility change –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å sync —Å –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (—Ä–∞–∑–¥–µ–ª 9.5, –ø—Ä–æ–±–ª–µ–º–∞ 15)
17. ‚ö†Ô∏è App.js –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ (—Ä–∞–∑–¥–µ–ª 9.3, –ø—Ä–æ–±–ª–µ–º–∞ 12)

---

## 10. –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –ø—Ä–æ–±–ª–µ–º

### 10.1. –ß—Ç–æ –±—É–¥–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º:**

1. ‚úÖ **–ü—É—Å—Ç–æ–π payload –Ω–µ –±—É–¥–µ—Ç —Å—Ç–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ**:
   - –ë—ç–∫–µ–Ω–¥ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ—Ä–¥–∂ –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏
   - –î–∞–∂–µ –µ—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø—É—Å—Ç–æ–π `{}`, —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è
   - `loadSession` –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å `answersRef.current`

2. ‚úÖ **–°–ø–æ–Ω—Ç–∞–Ω–Ω—ã–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã –Ω–µ –±—É–¥—É—Ç —Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ**:
   - Firebase –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø—É—Ç—å –î–û –æ—á–∏—Å—Ç–∫–∏ localStorage
   - –ë–æ–ª–µ–µ –º—è–≥–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
   - –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —á–µ—Ä–µ–∑ sync

3. ‚úÖ **Writing –±—É–¥–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä**:
   - –§—Ä–æ–Ω—Ç–µ–Ω–¥ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –¥–ª—è sync
   - –ß–µ—Ä–Ω–æ–≤–∏–∫–∏ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
   - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ—Ç–µ—Ä–∏ localStorage —Å—Ç–∞–Ω–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–º

4. ‚úÖ **Race conditions –±—É–¥—É—Ç —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã**:
   - Auto-submit –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å payload –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
   - Sync –∏ submit –±—É–¥—É—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
   - –¢–∞–π–º–µ—Ä—ã –±—É–¥—É—Ç –æ—á–∏—â–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### 10.2. –ß—Ç–æ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –≤–∞–∂–Ω–æ)

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ edge cases, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –æ—Å—Ç–∞—Ç—å—Å—è:**

1. ‚ö†Ô∏è **–û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç —Ä–∞–∑–Ω—ã—Ö –≤–∫–ª–∞–¥–æ–∫**:
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–ª —Ç–µ—Å—Ç –≤ –¥–≤—É—Ö –≤–∫–ª–∞–¥–∫–∞—Ö, –º–æ–≥—É—Ç –±—ã—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
   - –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `session.submitted`/`session.completed` –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º (—É–∂–µ –µ—Å—Ç—å)

2. ‚ö†Ô∏è **–û—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ**:
   - –ï—Å–ª–∏ sync/submit –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –æ—á–µ–Ω—å –¥–æ–ª–≥–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É
   - –†–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `navigator.sendBeacon` –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ submit –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏

3. ‚ö†Ô∏è **–û—à–∏–±–∫–∏ —Å–µ—Ç–∏ –≤–æ –≤—Ä–µ–º—è submit**:
   - –ï—Å–ª–∏ submit —É–ø–∞–¥—ë—Ç —Å —Å–µ—Ç–µ–≤–æ–π –æ—à–∏–±–∫–æ–π, –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω—ã
   - –†–µ—à–µ–Ω–∏–µ: retry –ª–æ–≥–∏–∫–∞ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º payload (—É–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ –µ—Å—Ç—å)

4. ‚ö†Ô∏è **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞**:
   - –ï—Å–ª–∏ –ë–î —É–ø–∞–¥—ë—Ç –≤–æ –≤—Ä–µ–º—è submit, –¥–∞–Ω–Ω—ã–µ –ø–æ—Ç–µ—Ä—è—é—Ç—Å—è
   - –†–µ—à–µ–Ω–∏–µ: —ç—Ç–æ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞, –Ω–µ –∫–æ–¥–æ–≤–∞—è

### 10.3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (—á—Ç–æ –º—ã –º–æ–≥–ª–∏ —É–ø—É—Å—Ç–∏—Ç—å)

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: Writing sync endpoint —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ URL –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

**–ù–∞–π–¥–µ–Ω–æ:**
- –ë—ç–∫–µ–Ω–¥: `WritingSessionSyncView` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—Å—Ç—Ä–æ–∫–∞ 1688 `backend/core/views.py`)
- URL: `path('writing-sessions/<int:session_id>/sync/', WritingSessionSyncView.as_view())` (—Å—Ç—Ä–æ–∫–∞ 157 `backend/core/urls.py`)
- –§—Ä–æ–Ω—Ç–µ–Ω–¥: –≤—ã–∑—ã–≤–∞–µ—Ç `PATCH /writing-sessions/${sessionId}/sync/` (—Å—Ç—Ä–æ–∫–∞ 123 `WritingTaskPage.js`)

**–í—ã–≤–æ–¥:** URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π! –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ —Ç–æ–º, —á—Ç–æ –º—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä–∏–ª–∏, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç. **–ù–û**: –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL.

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ Django

**–ù–∞–π–¥–µ–Ω–æ:**
- –í `backend/core/views.py` –Ω–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `@transaction.atomic` –∏–ª–∏ `select_for_update`
- –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –º–æ–≥—É—Ç –±—ã—Ç—å race conditions –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏–¥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (sync –∏ submit), –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å `@transaction.atomic` –∏ `select_for_update` –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π submit

**–ù–∞–π–¥–µ–Ω–æ:**
- Listening: –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ `if session.submitted` (—Å—Ç—Ä–æ–∫–∞ 2470)
- Reading: –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∞ `if session.completed` (—Å—Ç—Ä–æ–∫–∞ 3339)
- –ù–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ü–û–°–õ–ï –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –∏–∑ –ë–î

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
- –ú–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –¥—Ä—É–≥–æ–π submit
- –†–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `select_for_update` –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç—Ä–æ–∫–∏

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –°—Ç–∞—Ä—ã–π SubmitListeningTestView —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –º–µ—Ä–¥–∂–µ–º –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**–ù–∞–π–¥–µ–Ω–æ:**
- `SubmitListeningTestView` (—Å—Ç—Ä–æ–∫–∏ 2146-2208) –∏–º–µ–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ä–¥–∂
- –ù–æ –æ–Ω –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `urls.py`
- –¢–µ–∫—É—â–∏–π `ListeningTestSessionView.post` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—É—é –∑–∞–º–µ–Ω—É

**–í—ã–≤–æ–¥:** –≠—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤—Å–µ–≥–¥–∞ ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è.

### 10.4. –§–∏–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–æ–≥–æ, —á—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):**
1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å `ListeningTestSessionView.post` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–¥–∂ –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏
2. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å `ReadingTestSessionView.put` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–¥–∂ –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏
3. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å `loadSession` ‚Äî –æ–±–Ω–æ–≤–ª—è—Ç—å `answersRef.current`
4. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å Firebase ‚Äî –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø—É—Ç—å –î–û –æ—á–∏—Å—Ç–∫–∏ localStorage
5. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å Writing ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –¥–ª—è sync
6. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å auto-submit ‚Äî –ø—Ä–æ–≤–µ—Ä—è—Ç—å payload –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

**–í–∞–∂–Ω—ã–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):**
7. ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å `@transaction.atomic` –∏ `select_for_update` –¥–ª—è submit –æ–ø–µ—Ä–∞—Ü–∏–π
8. ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É payload –ø–µ—Ä–µ–¥ submit –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
9. ‚ö†Ô∏è –ò—Å–ø—Ä–∞–≤–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ localStorage ‚Äî –¥–µ–ª–∞—Ç—å –ü–û–°–õ–ï —É—Å–ø–µ—à–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
10. ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å retry –ª–æ–≥–∏–∫—É —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º payload

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ (–º–æ–∂–Ω–æ –ø–æ–∑–∂–µ):**
11. ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `navigator.sendBeacon` –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ submit
12. ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
13. ‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—É—Å—Ç—ã—Ö payload

### 10.5. –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º:**

- ‚úÖ **0% –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ submit** (–¥–∞–∂–µ –ø—Ä–∏ –ø—É—Å—Ç–æ–º payload)
- ‚úÖ **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤** (–¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
- ‚úÖ **Writing —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç** (—á–µ—Ä–Ω–æ–≤–∏–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
- ‚úÖ **–ù–µ—Ç —Å–ø–æ–Ω—Ç–∞–Ω–Ω—ã—Ö –ø–æ—Ç–µ—Ä—å –¥–∞–Ω–Ω—ã—Ö** (–º–µ—Ä–¥–∂ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø—É—Å—Ç–æ–≥–æ payload)

**–û—Å—Ç–∞–Ω—É—Ç—Å—è —Ç–æ–ª—å–∫–æ:**
- ‚ö†Ô∏è –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (–ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, —Å–µ—Ç—å —É–ø–∞–ª–∞)
- ‚ö†Ô∏è –û—á–µ–Ω—å —Ä–µ–¥–∫–∏–µ edge cases (–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏, –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ)

**–í—ã–≤–æ–¥:** –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç **—É—Å—Ç–æ–π—á–∏–≤–∞ –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö** –Ω–∞ 99%+. –û—Å—Ç–∞–≤—à–∏–µ—Å—è 1% ‚Äî —ç—Ç–æ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Ä–µ—à–∞—é—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–¥–∞.

---

## 11. –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏

### 11.1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –±–ª–æ–∫–∏—Ä—É—é—Ç –ø–æ—Ç–µ—Ä—é –¥–∞–Ω–Ω—ã—Ö)

#### 1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å Listening Submit ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–¥–∂
**–§–∞–π–ª:** `backend/core/views.py`, —Å—Ç—Ä–æ–∫–∞ 2483
**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
session.answers = submit_serializer.validated_data.get('answers', session.answers)
```
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
answers_data = submit_serializer.validated_data.get('answers')
if not isinstance(session.answers, dict):
    session.answers = {}
if isinstance(answers_data, dict):
    for question_id, answer_value in answers_data.items():
        if isinstance(answer_value, dict) and question_id in session.answers and isinstance(session.answers[question_id], dict):
            session.answers[question_id].update(answer_value)
        else:
            session.answers[question_id] = answer_value
```
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

#### 2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å Reading Submit ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–¥–∂
**–§–∞–π–ª:** `backend/core/views.py`, —Å—Ç—Ä–æ–∫–∞ 3344
**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```python
session.answers = answers_data
```
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
if not isinstance(session.answers, dict):
    session.answers = {}
if isinstance(answers_data, dict):
    for question_id, answer_value in answers_data.items():
        if isinstance(answer_value, dict) and question_id in session.answers and isinstance(session.answers[question_id], dict):
            session.answers[question_id].update(answer_value)
        else:
            session.answers[question_id] = answer_value
```
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

#### 3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å loadSession ‚Äî –æ–±–Ω–æ–≤–ª—è—Ç—å answersRef
**–§–∞–π–ª:** `frontend/src/components/ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∞ 218
**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```javascript
setAnswers(response.data.answers || {});
```
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```javascript
const serverAnswers = response.data.answers || {};
setAnswers(serverAnswers);
answersRef.current = serverAnswers;  // ‚ö†Ô∏è –î–û–ë–ê–í–ò–¢–¨
```
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

#### 4. –ò—Å–ø—Ä–∞–≤–∏—Ç—å Firebase ‚Äî –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø—É—Ç—å –î–û –æ—á–∏—Å—Ç–∫–∏ localStorage
**–§–∞–π–ª:** `frontend/src/firebase.js`, —Å—Ç—Ä–æ–∫–∏ 39-49
**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```javascript
localStorage.removeItem('token');
// ... —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
const publicPaths = ['/login', '/Ptest'];
if (!publicPaths.includes(window.location.pathname)) {
  window.location.href = '/login';
}
```
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```javascript
const publicPaths = ['/login', '/Ptest'];
const isPublicPath = publicPaths.includes(window.location.pathname);
if (!isPublicPath) {
  localStorage.removeItem('token');
  // ... —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
  window.location.href = '/login';
}
```
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

#### 5. –ò—Å–ø—Ä–∞–≤–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ localStorage ‚Äî –¥–µ–ª–∞—Ç—å –ü–û–°–õ–ï –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
**–§–∞–π–ª:** `frontend/src/components/ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∏ 503-509
**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```javascript
if (localCacheKeyRef.current) {
  localStorage.removeItem(localCacheKeyRef.current);
}
navigate(`/listening-result/${session.id}`);
```
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```javascript
navigate(`/listening-result/${session.id}`);
// –£–¥–∞–ª—è–µ–º localStorage –ü–û–°–õ–ï —É—Å–ø–µ—à–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
setTimeout(() => {
  if (localCacheKeyRef.current) {
    localStorage.removeItem(localCacheKeyRef.current);
  }
}, 100);
```
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

#### 6. –ò—Å–ø—Ä–∞–≤–∏—Ç—å auto-submit ‚Äî –ø—Ä–æ–≤–µ—Ä—è—Ç—å payload –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
**–§–∞–π–ª:** `frontend/src/components/ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∏ 297-299
**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```javascript
const payloadAnswers = answersRef.current || {};
await api.post(`/listening-sessions/${session.id}/submit/`, { answers: payloadAnswers, time_left: 0 });
```
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```javascript
const payloadAnswers = answersRef.current || answers || {};
if (Object.keys(payloadAnswers).length === 0) {
  console.error('‚ö†Ô∏è Auto-submit: Empty payload, skipping submit');
  alert('No answers to submit. Please fill in answers before time runs out.');
  return;
}
await api.post(`/listening-sessions/${session.id}/submit/`, { answers: payloadAnswers, time_left: 0 });
```
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

### 11.2. –í–∞–∂–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç —Ä–µ–¥–∫–∏–µ —Å–ª—É—á–∞–∏)

#### 7. –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è submit –æ–ø–µ—Ä–∞—Ü–∏–π
**–§–∞–π–ª:** `backend/core/views.py`, —Å—Ç—Ä–æ–∫–∏ 2478, 3344
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
from django.db import transaction

@transaction.atomic
def post(self, request, session_id=None):
    # ...
    session = ListeningTestSession.objects.select_for_update().get(pk=session_id, user=request.user)
    if session.submitted:
        return Response({'error': 'Session already submitted'}, status=400)
    # ... –º–µ—Ä–¥–∂ answers ...
    session.save()
```
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –í–ê–ñ–ù–´–ô

#### 8. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É payload –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ –ø–µ—Ä–µ–¥ submit
**–§–∞–π–ª:** `frontend/src/components/ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∞ 489
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```javascript
const payloadAnswers = answersRef.current || answers;
if (Object.keys(payloadAnswers).length === 0) {
  console.warn('‚ö†Ô∏è Submit: Empty payload detected, but proceeding (backend will merge safely)');
  // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
}
```
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –í–ê–ñ–ù–´–ô

#### 9. –ò—Å–ø—Ä–∞–≤–∏—Ç—å retry –ª–æ–≥–∏–∫—É ‚Äî –æ–±–Ω–æ–≤–ª—è—Ç—å payload
**–§–∞–π–ª:** `frontend/src/components/ListeningTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∏ 492-502
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```javascript
try {
  response = await api.post(`/listening-sessions/${session.id}/submit/`, { answers: payloadAnswers, time_left: remaining });
} catch (err) {
  if (err.response && (err.response.status === 401 || err.response.status === 403) && auth.currentUser) {
    await auth.currentUser.getIdToken(true);
    // ‚ö†Ô∏è –û–±–Ω–æ–≤–ª—è–µ–º payload –ø–µ—Ä–µ–¥ retry
    const freshPayload = answersRef.current || answers || {};
    response = await api.post(`/listening-sessions/${session.id}/submit/`, { answers: freshPayload, time_left: remaining });
  } else {
    throw err;
  }
}
```
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –í–ê–ñ–ù–´–ô

#### 10. –ò—Å–ø—Ä–∞–≤–∏—Ç—å Writing localStorage —É–¥–∞–ª–µ–Ω–∏–µ
**–§–∞–π–ª:** `frontend/src/pages/WritingTaskPage.js`, —Å—Ç—Ä–æ–∫–∏ 179-183
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```javascript
await withRetry(() => api.post('/finish-writing-session/', { session_id: sessionId }));
navigate(`/writing/result/${sessionId}`);
// –£–¥–∞–ª—è–µ–º –ü–û–°–õ–ï –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
setTimeout(() => {
  localStorage.removeItem(`writing_task1_${sessionId}`);
  localStorage.removeItem(`writing_task2_${sessionId}`);
  localStorage.removeItem(`writing_deadline_${sessionId}`);
}, 100);
```
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –í–ê–ñ–ù–´–ô

### 11.3. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–º–æ–∂–Ω–æ –ø–æ–∑–∂–µ, —É–ª—É—á—à–∞—é—Ç UX)

#### 11. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
**–§–∞–π–ª:** `backend/core/views.py`
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
import logging
logger = logging.getLogger(__name__)

# –í submit –º–µ—Ç–æ–¥–∞—Ö
answers_before = session.answers.copy() if isinstance(session.answers, dict) else {}
answers_in_request = submit_serializer.validated_data.get('answers')
logger.info(f"Submit session {session_id}: answers_before_keys={len(answers_before)}, answers_in_request_keys={len(answers_in_request) if isinstance(answers_in_request, dict) else 0}")
```
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –û–ü–¶–ò–û–ù–ê–õ–¨–ù–´–ô

#### 12. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å navigator.sendBeacon –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ submit
**–§–∞–π–ª:** `frontend/src/components/ListeningTestPlayer.jsx`
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```javascript
// –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
window.addEventListener('beforeunload', () => {
  if (session && !isSubmitted) {
    const payload = JSON.stringify({ answers: answersRef.current || answers, time_left: remaining });
    navigator.sendBeacon(`/api/listening-sessions/${session.id}/submit/`, payload);
  }
});
```
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –û–ü–¶–ò–û–ù–ê–õ–¨–ù–´–ô

#### 13. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—É—Å—Ç—ã—Ö payload
**–§–∞–π–ª:** `backend/core/views.py`
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
from django.core.cache import cache

# –í submit –º–µ—Ç–æ–¥–∞—Ö
if isinstance(answers_in_request, dict) and len(answers_in_request) == 0:
    cache.incr('listening_submit_empty_payload', 1)
```
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –û–ü–¶–ò–û–ù–ê–õ–¨–ù–´–ô

### 11.4. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (—á—Ç–æ –µ—â–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–ø—É—â–µ–Ω–æ)

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –±—ç–∫–µ–Ω–¥–µ
**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–µ dict, –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç), –±—ç–∫–µ–Ω–¥ –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å
- –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –º–µ—Ä–¥–∂–µ–º

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –†–∞–∑–º–µ—Ä payload
**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç–æ–≤ –æ—á–µ–Ω—å –º–Ω–æ–≥–æ, payload –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–º
- –†–µ—à–µ–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç—ã Django/nginx

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ö–æ–¥–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
- –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –æ—Ç–≤–µ—Ç–∞—Ö –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω—ã
- –†–µ—à–µ–Ω–∏–µ: —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è UTF-8

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–ª —Ç–µ—Å—Ç –Ω–∞ –¥–≤—É—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö, –º–æ–≥—É—Ç –±—ã—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
- –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `last_updated` timestamp

### 11.5. –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (–¥–µ–ª–∞–µ–º –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å):**
- [ ] 1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å Listening Submit ‚Äî –º–µ—Ä–¥–∂
- [ ] 2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å Reading Submit ‚Äî –º–µ—Ä–¥–∂
- [ ] 3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å loadSession ‚Äî –æ–±–Ω–æ–≤–ª—è—Ç—å answersRef
- [ ] 4. –ò—Å–ø—Ä–∞–≤–∏—Ç—å Firebase ‚Äî –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø—É—Ç—å –î–û –æ—á–∏—Å—Ç–∫–∏
- [ ] 5. –ò—Å–ø—Ä–∞–≤–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ localStorage ‚Äî –ü–û–°–õ–ï –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
- [ ] 6. –ò—Å–ø—Ä–∞–≤–∏—Ç—å auto-submit ‚Äî –ø—Ä–æ–≤–µ—Ä—è—Ç—å payload

**–í–∞–∂–Ω—ã–µ (–¥–µ–ª–∞–µ–º –ø–æ—Å–ª–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö):**
- [ ] 7. –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è submit
- [ ] 8. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É payload –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
- [ ] 9. –ò—Å–ø—Ä–∞–≤–∏—Ç—å retry –ª–æ–≥–∏–∫—É
- [ ] 10. –ò—Å–ø—Ä–∞–≤–∏—Ç—å Writing localStorage —É–¥–∞–ª–µ–Ω–∏–µ

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ (–º–æ–∂–Ω–æ –ø–æ–∑–∂–µ):**
- [ ] 11. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] 12. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å navigator.sendBeacon
- [ ] 13. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

### 11.6. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –º–æ–≥–ª–∏ —É–ø—É—Å—Ç–∏—Ç—å

#### –ü—Ä–æ–±–ª–µ–º–∞ 18: Reading startSessionAndLoadTest –æ–±–Ω–æ–≤–ª—è–µ—Ç answersRef, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å race condition

**–§–∞–π–ª:** `frontend/src/components/ReadingTestPlayer.jsx`, —Å—Ç—Ä–æ–∫–∏ 219-280
**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```javascript
const startSessionAndLoadTest = async () => {
  // ...
  let serverAnswers = response.data.answers || {};
  let cachedAnswers = {};
  // ... –ø–∞—Ä—Å–∏–Ω–≥ localStorage ...
  const mergedAnswers = { ...serverAnswers };
  // ... –º–µ—Ä–¥–∂ ...
  answersRef.current = migratedAnswers;  // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
  setAnswers(migratedAnswers);
}
```

**–í—ã–≤–æ–¥:** Reading –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç `answersRef.current` –≤ `startSessionAndLoadTest`. **–ù–û**: –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–µ—Å—Å–∏–∏ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ `loadSession` –≤ Listening), –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—ë —Ç–æ–∂–µ.

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏ —á–µ—Ä–µ–∑ –¥—Ä—É–≥–æ–π –ø—É—Ç—å, –º–æ–∂–µ—Ç –±—ã—Ç—å race condition
- –†–µ—à–µ–Ω–∏–µ: —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –ø—É—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç `answersRef.current`

#### –ü—Ä–æ–±–ª–µ–º–∞ 19: –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –ø—É—Å—Ç–æ–π dict –∫–∞–∫ –≤–∞–ª–∏–¥–Ω—ã–π

**–§–∞–π–ª:** `backend/core/serializers.py`, —Å—Ç—Ä–æ–∫–∏ 2259-2263
```python
class ListeningTestSessionSubmitSerializer(serializers.ModelSerializer):
    class Meta:
        model = ListeningTestSession
        fields = ['answers', 'flagged', 'time_left', 'submitted']
        read_only_fields = ['submitted']
```

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
- –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä –Ω–µ –∏–º–µ–µ—Ç `required=False` –¥–ª—è `answers`, –Ω–æ –ø—Ä–∏ `partial=True` –º–æ–∂–µ—Ç –ø—Ä–∏–Ω—è—Ç—å –ø—É—Å—Ç–æ–π `{}`
- –ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–∏—Ç `{ answers: {} }`, —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä –ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —ç—Ç–æ –∫–∞–∫ –≤–∞–ª–∏–¥–Ω–æ–µ
- –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä –∏–ª–∏ –≤ view

#### –ü—Ä–æ–±–ª–µ–º–∞ 20: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ payload

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç–æ–≤ –æ—á–µ–Ω—å –º–Ω–æ–≥–æ, payload –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã Django/nginx
- –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–∞–∑–º–µ—Ä–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

#### –ü—Ä–æ–±–ª–µ–º–∞ 21: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–∞—Å—Å–∏–≤ –≤–º–µ—Å—Ç–æ –æ–±—ä–µ–∫—Ç–∞), –±—ç–∫–µ–Ω–¥ –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å
- –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –º–µ—Ä–¥–∂–µ–º

#### –ü—Ä–æ–±–ª–µ–º–∞ 22: –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç —Ä–∞–∑–Ω—ã—Ö –≤–∫–ª–∞–¥–æ–∫

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–ª —Ç–µ—Å—Ç –≤ –¥–≤—É—Ö –≤–∫–ª–∞–¥–∫–∞—Ö, –º–æ–≥—É—Ç –±—ã—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
- –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `last_updated` timestamp –∏ –æ—Ç–∫–ª–æ–Ω—è—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–∞–ø—Ä–æ—Å—ã

#### –ü—Ä–æ–±–ª–µ–º–∞ 23: –ö–æ–¥–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
- –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –æ—Ç–≤–µ—Ç–∞—Ö –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω—ã –ø—Ä–∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- –†–µ—à–µ–Ω–∏–µ: —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è UTF-8 –≤–µ–∑–¥–µ

### 11.7. –§–∏–Ω–∞–ª—å–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç –≤—Å–µ—Ö –ø—Ä–æ–±–ª–µ–º

**–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ: 23 –ø—Ä–æ–±–ª–µ–º—ã**

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (6):**
1. ‚úÖ Listening Submit ‚Äî –Ω–µ—Ç –º–µ—Ä–¥–∂–∞
2. ‚úÖ Reading Submit ‚Äî –Ω–µ—Ç –º–µ—Ä–¥–∂–∞
3. ‚úÖ loadSession –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç answersRef (Listening)
4. ‚úÖ Firebase –æ—á–∏—â–∞–µ—Ç localStorage –î–û –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—É—Ç–∏
5. ‚úÖ localStorage —É–¥–∞–ª—è–µ—Ç—Å—è –î–û –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
6. ‚úÖ auto-submit –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç payload

**–í–∞–∂–Ω—ã–µ (6):**
7. ‚ö†Ô∏è –ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è submit
8. ‚ö†Ô∏è –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ payload –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
9. ‚ö†Ô∏è Retry –ª–æ–≥–∏–∫–∞ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç payload
10. ‚ö†Ô∏è Writing localStorage —É–¥–∞–ª—è–µ—Ç—Å—è –î–û –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
11. ‚ö†Ô∏è Race condition –≤ auto-submit
12. ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ 401/403 ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏—è

**–°—Ä–µ–¥–Ω–∏–µ (5):**
13. ‚ö†Ô∏è API interceptor –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
14. ‚ö†Ô∏è Auto-submit –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–∞–¥–µ–Ω–∏—è sync
15. ‚ö†Ô∏è –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç–∞–π–º–µ—Ä—ã –±–µ–∑ –æ—á–∏—Å—Ç–∫–∏
16. ‚ö†Ô∏è Visibility change –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å sync —Å –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
17. ‚ö†Ô∏è App.js –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

**–ù–∏–∑–∫–∏–µ (6):**
18. ‚ö†Ô∏è Reading loadSession –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç answersRef (–Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å)
19. ‚ö†Ô∏è –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø—É—Å—Ç–æ–π dict
20. ‚ö†Ô∏è –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ payload
21. ‚ö†Ô∏è –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
22. ‚ö†Ô∏è –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç —Ä–∞–∑–Ω—ã—Ö –≤–∫–ª–∞–¥–æ–∫
23. ‚ö†Ô∏è –ö–æ–¥–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö

### 11.8. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

**–§–∞–∑–∞ 1 (–∫—Ä–∏—Ç–∏—á–Ω–æ, –¥–µ–ª–∞–µ–º —Å—Ä–∞–∑—É):**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è 1-6 (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ)

**–§–∞–∑–∞ 2 (–≤–∞–∂–Ω–æ, –¥–µ–ª–∞–µ–º –ø–æ—Å–ª–µ —Ñ–∞–∑—ã 1):**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è 7-12 (–≤–∞–∂–Ω—ã–µ)

**–§–∞–∑–∞ 3 (—É–ª—É—á—à–µ–Ω–∏—è, –¥–µ–ª–∞–µ–º –ø–æ—Å–ª–µ —Ñ–∞–∑—ã 2):**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è 13-17 (—Å—Ä–µ–¥–Ω–∏–µ)

**–§–∞–∑–∞ 4 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –ø–æ–∑–∂–µ):**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è 18-23 (–Ω–∏–∑–∫–∏–µ)

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã:**
- –§–∞–∑–∞ 1: 0% –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ submit
- –§–∞–∑–∞ 2: 0% –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö
- –§–∞–∑–∞ 3: –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ UX
- –§–∞–∑–∞ 4: –ó–∞—â–∏—Ç–∞ –æ—Ç edge cases

---

## 12. –ê–Ω–∞–ª–∏–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —Å–µ—Å—Å–∏–π

### 12.1. –ì–¥–µ –º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–∫–µ–Ω –∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã

#### 12.1.1. `frontend/src/firebase.js` ‚Äî –≥–ª–∞–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∂—ë—Å—Ç–∫–∏—Ö —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤

**–ö–æ–¥:**
```19:53:frontend/src/firebase.js
onIdTokenChanged(auth, async (user) => {
  if (user) {
    try {
      const token = await user.getIdToken();
      localStorage.setItem('token', token);
    } catch (e) {
      // –µ—Å–ª–∏ –Ω–µ —Å–º–æ–≥–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω ‚Äî –Ω–µ —Ä–≤—ë–º —Å–µ—Å—Å–∏—é –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
    }
  } else {
    // –ú—è–≥–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –ø—Ä–æ–±—É–µ–º –ø–æ–¥–æ–∂–¥–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è
    setTimeout(async () => {
      if (auth.currentUser) {
        try {
          const token = await auth.currentUser.getIdToken(true);
          localStorage.setItem('token', token);
          return;
        } catch (e) {
          // fallthrough to logout
        }
      }
      localStorage.removeItem('token');
      localStorage.removeItem('uid');
      localStorage.removeItem('role');
      localStorage.removeItem('student_id');
      localStorage.removeItem('first_name');
      localStorage.removeItem('last_name');
      localStorage.removeItem('group');
      // –ü—É–±–ª–∏—á–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ —Ç—Ä–µ–±—É—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      const publicPaths = ['/login', '/Ptest'];
      if (!publicPaths.includes(window.location.pathname)) {
        window.location.href = '/login';
      }
    }, 1500);
  }
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü—Ä–∏ –ª—é–±–æ–º —Å–æ–±—ã—Ç–∏–∏ `onIdTokenChanged` —Å `user = null`:
  1. –ß–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã –ø—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è (`getIdToken(true)`)
  2. –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å ‚Üí –æ—á–∏—â–∞–µ—Ç **–≤—Å–µ** –¥–∞–Ω–Ω—ã–µ –∏–∑ `localStorage` (token, uid, role, student_id, first_name, last_name, group)
  3. –ï—Å–ª–∏ –ø—É—Ç—å –Ω–µ `/login` –∏ –Ω–µ `/Ptest` ‚Üí –¥–µ–ª–∞–µ—Ç **–∂—ë—Å—Ç–∫–∏–π `window.location.href = '/login'`**

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:**
- üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø** ‚Äî —ç—Ç–æ –≥–ª–∞–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ "—Å–ø–æ–Ω—Ç–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π" –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞
- –í–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞ (Listening/Reading/Writing) —Ç–æ–∫–µ–Ω –º–æ–∂–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–ø–∞—Å—Ç—å/–Ω–µ –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
- –ß–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã –∫–æ–¥:
  - –í—ã—á–∏—â–∞–µ—Ç `localStorage` (–≤–∫–ª—é—á–∞—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –∫–µ—à–∞ —Ç–µ—Å—Ç–æ–≤)
  - –î–µ–ª–∞–µ—Ç **–ø–æ–ª–Ω—ã–π reload —Å—Ç—Ä–∞–Ω–∏—Ü—ã** —á–µ—Ä–µ–∑ `window.location.href`
- –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç `navigate('/login')`, **–∂—ë—Å—Ç–∫–∏–π reload** –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –º–æ–∂–µ—Ç —É–±–∏—Ç—å –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```javascript
onIdTokenChanged(auth, async (user) => {
  if (user) {
    try {
      const token = await user.getIdToken();
      localStorage.setItem('token', token);
    } catch (e) {
      // –µ—Å–ª–∏ –Ω–µ —Å–º–æ–≥–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω ‚Äî –Ω–µ —Ä–≤—ë–º —Å–µ—Å—Å–∏—é –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
    }
  } else {
    setTimeout(async () => {
      if (auth.currentUser) {
        try {
          const token = await auth.currentUser.getIdToken(true);
          localStorage.setItem('token', token);
          return;
        } catch (e) {
          // fallthrough to logout
        }
      }
      
      // ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—É—Ç—å –î–û –æ—á–∏—Å—Ç–∫–∏ localStorage
      const publicPaths = ['/login', '/Ptest'];
      const testPaths = ['/listening', '/reading', '/writing'];
      const currentPath = window.location.pathname;
      const isPublicPath = publicPaths.includes(currentPath);
      const isTestPath = testPaths.some(path => currentPath.includes(path));
      
      // –ï—Å–ª–∏ –Ω–∞ —Ç–µ—Å—Ç–µ ‚Äî –ù–ï –¥–µ–ª–∞–µ–º –∂—ë—Å—Ç–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç, —Ç–æ–ª—å–∫–æ –æ—á–∏—â–∞–µ–º auth –¥–∞–Ω–Ω—ã–µ
      // (–Ω–æ –ù–ï —Ç—Ä–æ–≥–∞–µ–º –∫–µ—à —Ç–µ—Å—Ç–æ–≤ –≤ localStorage)
      if (isTestPath) {
        // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ auth –¥–∞–Ω–Ω—ã–µ, –ù–ï –∫–µ—à —Ç–µ—Å—Ç–æ–≤
        localStorage.removeItem('token');
        localStorage.removeItem('uid');
        localStorage.removeItem('role');
        localStorage.removeItem('student_id');
        localStorage.removeItem('first_name');
        localStorage.removeItem('last_name');
        localStorage.removeItem('group');
        // –ù–ï –¥–µ–ª–∞–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç ‚Äî –ø—É—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ç–µ—Å—Ç
        // (–µ—Å–ª–∏ –æ–Ω –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å, –ø–æ–ª—É—á–∏—Ç 401 –∏ —Ç–æ–≥–¥–∞ —É–∂–µ navigate –º—è–≥–∫–æ)
        return;
      }
      
      // –ï—Å–ª–∏ –ù–ï –Ω–∞ —Ç–µ—Å—Ç–µ ‚Äî –æ—á–∏—â–∞–µ–º –≤—Å—ë –∏ –¥–µ–ª–∞–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç
      localStorage.removeItem('token');
      localStorage.removeItem('uid');
      localStorage.removeItem('role');
      localStorage.removeItem('student_id');
      localStorage.removeItem('first_name');
      localStorage.removeItem('last_name');
      localStorage.removeItem('group');
      
      if (!isPublicPath) {
        window.location.href = '/login';
      }
    }, 1500);
  }
});
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

#### 12.1.2. `frontend/src/api.js` ‚Äî –∏–Ω—Ç–µ—Ä—Ü–µ–ø—Ç–æ—Ä—ã –¥–ª—è —Ç–æ–∫–µ–Ω–∞

**–ö–æ–¥:**
```33:74:frontend/src/api.js
api.interceptors.request.use(async (config) => {
  const isPublicEndpoint = config.url && (
    config.url.includes('/placement-test/') ||
    config.url.includes('/login/')
  );
  
  if (!isPublicEndpoint) {
    await waitForAuth();
    
    const user = auth.currentUser;
    if (user) {
      const token = await user.getIdToken();
      config.headers['Authorization'] = `Bearer ${token}`;
    }
  }
  return config;
}, (error) => Promise.reject(error));

api.interceptors.response.use(
  (response) => response,
  async (error) => {
    const originalRequest = error.config;
    if (!originalRequest || originalRequest._retry) {
      return Promise.reject(error);
    }
    const status = error.response?.status;
    if ((status === 401 || status === 403) && auth?.currentUser) {
      originalRequest._retry = true;
      try {
        const newToken = await auth.currentUser.getIdToken(true);
        originalRequest.headers = originalRequest.headers || {};
        originalRequest.headers['Authorization'] = `Bearer ${newToken}`;
        return api(originalRequest);
      } catch (refreshErr) {
        return Promise.reject(refreshErr);
      }
    }
    return Promise.reject(error);
  }
);
```

**–ê–Ω–∞–ª–∏–∑:**
- ‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:**
  - –ü–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º –∂–¥—ë—Ç `onAuthStateChanged` –∏ –±–µ—Ä—ë—Ç —Å–≤–µ–∂–∏–π —Ç–æ–∫–µ–Ω
  - –ü—Ä–∏ 401/403 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –∏ —Ä–µ—Ç—Ä–∞–∏—Ç –∑–∞–ø—Ä–æ—Å
- ‚ö†Ô∏è **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:**
  - –ï—Å–ª–∏ Firebase –≤—Ä–µ–º–µ–Ω–Ω–æ "—Ç–µ—Ä—è–µ—Ç" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí `auth.currentUser` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `null`
  - `waitForAuth` –º–æ–∂–µ—Ç –æ—Ç—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ —Å—Ç–∞—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  - –ó–∞–ø—Ä–æ—Å—ã –Ω–∞—á–Ω—É—Ç –ø–∞–¥–∞—Ç—å —Å 401/403
  - –≠—Ç–æ –≤ —Å–≤—è–∑–∫–µ —Å `firebase.js` –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –∫–∞—Å–∫–∞–¥:
    1. –ó–∞–ø—Ä–æ—Å—ã –ø–∞–¥–∞—é—Ç ‚Üí –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Listening/Reading –¥–µ–ª–∞—é—Ç `navigate('/login')` (–º—è–≥–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥)
    2. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ `onIdTokenChanged` —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞ `user = null` ‚Üí —á–µ—Ä–µ–∑ 1.5s –¥–µ–ª–∞–µ—Ç –∂—ë—Å—Ç–∫–∏–π reload

**–í—ã–≤–æ–¥:** –ò–Ω—Ç–µ—Ä—Ü–µ–ø—Ç–æ—Ä—ã —Å–∞–º–∏ –ø–æ —Å–µ–±–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã, –Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ —Å–≤—è–∑–∫–µ —Å `firebase.js`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å –∂—ë—Å—Ç–∫–∏–π reload.

#### 12.1.3. –ü–µ—Ä–µ—Ö–æ–¥—ã –Ω–∞ `/login` –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö

**–ù–∞–π–¥–µ–Ω–æ:**
- `frontend/src/pages/WritingPromptsAdminPage.js`: `navigate("/login")`
- `frontend/src/pages/AdminWritingTestBuilder.js`: `navigate("/login")`
- `frontend/src/components/Sidebar*.jsx`: `navigate('/login')`
- `frontend/src/components/Navbar*.js`: `navigate('/login')`
- `frontend/src/components/BottomNavigation.jsx`: `navigate('/login')`
- `frontend/src/components/ListeningTestPlayer.jsx`: `setTimeout(() => navigate('/login'), 1500)`
- `frontend/src/components/ReadingTestPlayer.jsx`: `setTimeout(() => navigate('/login'), 1500)`
- `frontend/src/App.js`: `!role ? <Navigate to="/login" /> : ...`

**–ê–Ω–∞–ª–∏–∑:**
- ‚úÖ **–í—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —á–µ—Ä–µ–∑ `navigate` / `<Navigate/>`** ‚Äî —ç—Ç–æ SPA-–ø–µ—Ä–µ—Ö–æ–¥—ã, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
- ‚úÖ `localStorage` –Ω–µ —á–∏—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—á–∏—Å—Ç–∫–∞ —Ç–æ–ª—å–∫–æ —Ç–∞–º, –≥–¥–µ —è–≤–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `localStorage.removeItem` –ø–µ—Ä–µ–¥ `navigate`)
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω—ã** –¥–ª—è —Ç–µ—Å—Ç–æ–≤, —Ç–∞–∫ –∫–∞–∫ –Ω–µ –≤—ã–∑—ã–≤–∞—é—Ç –ø–æ–ª–Ω—ã–π reload

**–í—ã–≤–æ–¥:** –í—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –Ω–∞ `/login` –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö –±–µ–∑–æ–ø–∞—Å–Ω—ã. –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–ø–∞—Å–Ω–æ–µ –º–µ—Å—Ç–æ ‚Äî `firebase.js` —Å `window.location.href`.

### 12.2. –ò—Ç–æ–≥–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–±–ª–µ–º –ø–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ:**
1. ‚úÖ `firebase.js` –¥–µ–ª–∞–µ—Ç –∂—ë—Å—Ç–∫–∏–π `window.location.href` –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞ (—Å—Ç—Ä–æ–∫–∞ 49)
2. ‚úÖ `firebase.js` –æ—á–∏—â–∞–µ—Ç `localStorage` –î–û –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—É—Ç–∏ (—Å—Ç—Ä–æ–∫–∏ 39-45)

**–í–∞–∂–Ω—ã–µ:**
3. ‚ö†Ô∏è –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç –æ—á–∏—Å—Ç–∫–∏ –∫–µ—à–∞ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–∏ auth-–æ—à–∏–±–∫–µ (–ø–æ–∫–∞ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –ø—Ä–æ–±–ª–µ–º–æ–π)

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:**
4. ‚ö†Ô∏è –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ —É–º–Ω—É—é –ª–æ–≥–∏–∫—É: –µ—Å–ª–∏ –Ω–∞ —Ç–µ—Å—Ç–µ –∏ —Ç–æ–∫–µ–Ω –ø—Ä–æ–ø–∞–ª, –ø–æ–∫–∞–∑–∞—Ç—å –±–∞–Ω–Ω–µ—Ä "Session expired, please login" –Ω–æ –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É

### 12.3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –°–º—è–≥—á–∏—Ç—å `firebase.js` ‚Äî –Ω–µ –¥–µ–ª–∞—Ç—å –∂—ë—Å—Ç–∫–∏–π reload –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞**

**–§–∞–π–ª:** `frontend/src/firebase.js`, —Å—Ç—Ä–æ–∫–∏ 19-53

**–ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```javascript
onIdTokenChanged(auth, async (user) => {
  if (user) {
    try {
      const token = await user.getIdToken();
      localStorage.setItem('token', token);
    } catch (e) {
      // –µ—Å–ª–∏ –Ω–µ —Å–º–æ–≥–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω ‚Äî –Ω–µ —Ä–≤—ë–º —Å–µ—Å—Å–∏—é –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
    }
  } else {
    setTimeout(async () => {
      if (auth.currentUser) {
        try {
          const token = await auth.currentUser.getIdToken(true);
          localStorage.setItem('token', token);
          return;
        } catch (e) {
          // fallthrough to logout
        }
      }
      
      // ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—É—Ç—å –î–û –æ—á–∏—Å—Ç–∫–∏ localStorage
      const publicPaths = ['/login', '/Ptest'];
      const testPaths = ['/listening', '/reading', '/writing'];
      const currentPath = window.location.pathname;
      const isPublicPath = publicPaths.includes(currentPath);
      const isTestPath = testPaths.some(path => currentPath.includes(path));
      
      // –ï—Å–ª–∏ –Ω–∞ —Ç–µ—Å—Ç–µ ‚Äî –ù–ï –¥–µ–ª–∞–µ–º –∂—ë—Å—Ç–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç, —Ç–æ–ª—å–∫–æ –æ—á–∏—â–∞–µ–º auth –¥–∞–Ω–Ω—ã–µ
      if (isTestPath) {
        localStorage.removeItem('token');
        localStorage.removeItem('uid');
        localStorage.removeItem('role');
        localStorage.removeItem('student_id');
        localStorage.removeItem('first_name');
        localStorage.removeItem('last_name');
        localStorage.removeItem('group');
        // –ù–ï –¥–µ–ª–∞–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç ‚Äî –ø—É—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ç–µ—Å—Ç
        // (–µ—Å–ª–∏ –æ–Ω –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å, –ø–æ–ª—É—á–∏—Ç 401 –∏ —Ç–æ–≥–¥–∞ —É–∂–µ navigate –º—è–≥–∫–æ)
        return;
      }
      
      // –ï—Å–ª–∏ –ù–ï –Ω–∞ —Ç–µ—Å—Ç–µ ‚Äî –æ—á–∏—â–∞–µ–º –≤—Å—ë –∏ –¥–µ–ª–∞–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç
      localStorage.removeItem('token');
      localStorage.removeItem('uid');
      localStorage.removeItem('role');
      localStorage.removeItem('student_id');
      localStorage.removeItem('first_name');
      localStorage.removeItem('last_name');
      localStorage.removeItem('group');
      
      if (!isPublicPath) {
        window.location.href = '/login';
      }
    }, 1500);
  }
});
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

---

## 13. –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö —Å–µ—Å—Å–∏–π –∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤

### 13.1. –¢–µ–∫—É—â–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞

**–ü–æ–ª–∏—Ç–∏–∫–∞:** ‚úÖ **–†–∞–∑—Ä–µ—à–∞–µ–º** –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ç–µ—Å—Ç –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö/–≤–∫–ª–∞–¥–∫–∞—Ö.

### 13.2. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ç–∫–µ–Ω–¥

#### 13.2.1. Listening ‚Äî –æ–¥–Ω–∞ —Å–µ—Å—Å–∏—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–µ—Å—Ç

**–ö–æ–¥:**
```2408:2462:backend/core/views.py
def post(self, request, test_id=None, session_id=None):
    if test_id:
        test = get_object_or_404(ListeningTest, pk=test_id)
        # Diagnostic flag from query/body
        diagnostic_flag = request.query_params.get('diagnostic') == 'true' or request.data.get('diagnostic') == True
        
        # –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—É—é —Å–µ—Å—Å–∏—é –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–µ—Å—Ç–∞
        existing_sessions = ListeningTestSession.objects.filter(
            user=request.user,
            test=test,
            submitted=False
        ).order_by('-created_at')
        
        if existing_sessions.exists():
            last_session = existing_sessions.first()
            # –ï—Å–ª–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–ø—Ä–æ—à–µ–Ω–∞, –Ω–æ —Å–µ—Å—Å–∏—è –Ω–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è ‚Äî —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é
            if diagnostic_flag and not last_session.is_diagnostic:
                session = ListeningTestSession.objects.create(...)
            else:
                session = last_session
                # –ï—Å–ª–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–ø—Ä–æ—à–µ–Ω–∞ –∏ —Å–µ—Å—Å–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è, –Ω–æ —Ñ–ª–∞–≥ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚Äî —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
                if diagnostic_flag and not session.is_diagnostic:
                    session.is_diagnostic = True
                    session.save(update_fields=['is_diagnostic'])
            created = False
        else:
            # –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é
            session = ListeningTestSession.objects.create(...)
```

**–ê–Ω–∞–ª–∏–∑:**
- ‚úÖ –î–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–¥–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –±—ç–∫–µ–Ω–¥ **–ø—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—É—é —Å–µ—Å—Å–∏—é**
- ‚úÖ –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ—ë
- ‚úÖ –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é

**–í—ã–≤–æ–¥:**
- –ï—Å–ª–∏ —É—á–µ–Ω–∏–∫ –æ—Ç–∫—Ä—ã–ª Listening –Ω–∞ –Ω–æ—É—Ç–±—É–∫–µ –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–µ ‚Üí –æ–±–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç–∞—é—Ç —Å **–æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ `session.id`**
- –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª–∏—Ç–∏–∫–∏ "–º–æ–∂–Ω–æ —Å —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤"

#### 13.2.2. Reading ‚Äî –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ Listening

**–ö–æ–¥:**
```3288:3293:backend/core/views.py
def post(self, request, test_id):
    """
    Start (or resume) a test session.
    """
    test = get_object_or_404(ReadingTest, pk=test_id)
    # ... –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞/—Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ Listening:
    # - –∏—â–µ—Ç –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—É—é —Å–µ—Å—Å–∏—é –¥–ª—è (user, test)
    # - –µ—Å–ª–∏ –µ—Å—Ç—å -> –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ—ë
    # - –µ—Å–ª–∏ –Ω–µ—Ç -> —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é
```

**–í—ã–≤–æ–¥:** –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ Listening ‚Äî –æ–¥–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–µ—Å—Ç.

#### 13.2.3. Writing ‚Äî –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ

**–ö–æ–¥:**
```1433:1441:backend/core/views.py
class StartWritingSessionView(APIView):
    permission_classes = [AllowAny]

    def post(self, request, test_id=None):
        auth_header = request.META.get('HTTP_AUTHORIZATION', '')
        if not auth_header.startswith('Bearer '):
            return Response({'error': 'Authentication required'}, status=401)
        id_token = auth_header.split(' ')[1]
        decoded = verify_firebase_token(id_token)
        # ... –ø–æ–ª—É—á–∞–µ–º user –ø–æ uid –∏ —Ä–∞–±–æ—Ç–∞–µ–º —Å –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–µ–π ...
```

**–í—ã–≤–æ–¥:** Writing —Ç–æ–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ Firebase-—Ç–æ–∫–µ–Ω, —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–µ–π.

### 13.3. –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

#### –ü—Ä–æ–±–ª–µ–º–∞ 1: Race conditions –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 1 –¥–µ–ª–∞–µ—Ç `sync` (PATCH) –≤ –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 2 –¥–µ–ª–∞–µ—Ç `submit` (POST)
- –û–±–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –ë–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å `@transaction.atomic` –∏ `select_for_update` –¥–ª—è submit –æ–ø–µ—Ä–∞—Ü–∏–π (—É–∂–µ –≤ –ø–ª–∞–Ω–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π)

#### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π overwrite –ø—Ä–∏ submit

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 1 –∑–∞–ø–æ–ª–Ω–∏–ª–æ –æ—Ç–≤–µ—Ç—ã –∏ –¥–µ–ª–∞–µ—Ç `submit` —Å –ø–æ–ª–Ω—ã–º payload
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 2 –∑–∞–ø–æ–ª–Ω–∏–ª–æ –¥—Ä—É–≥–∏–µ –æ—Ç–≤–µ—Ç—ã –∏ –¥–µ–ª–∞–µ—Ç `submit` —Å –¥—Ä—É–≥–∏–º –ø–æ–ª–Ω—ã–º payload
- –ï—Å–ª–∏ submit –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç `session.answers` –±–µ–∑ –º–µ—Ä–¥–∂–∞ ‚Üí —Ç–µ—Ä—è—é—Ç—Å—è –æ—Ç–≤–µ—Ç—ã —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ 1

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ä–¥–∂ –ø—Ä–∏ submit (—É–∂–µ –≤ –ø–ª–∞–Ω–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π)

#### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö sync

**–°—Ü–µ–Ω–∞—Ä–∏–π:**
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 1 –¥–µ–ª–∞–µ—Ç `sync` –≤ 10:00:00
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 2 –¥–µ–ª–∞–µ—Ç `sync` –≤ 10:00:05 (–±–æ–ª–µ–µ —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ)
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ 1 –¥–µ–ª–∞–µ—Ç `sync` –≤ 10:00:10 (—É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ) ‚Üí –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ 2

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `last_updated` –≤ —Å–µ—Å—Å–∏—é
- –ö–ª–∏–µ–Ω—Ç —à–ª—ë—Ç `last_updated` –≤ payload
- –ï—Å–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ `session.last_updated > payload.last_updated` ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–π sync

### 13.4. –ò—Ç–æ–≥–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–±–ª–µ–º –ø–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–º —Å–µ—Å—Å–∏—è–º

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ:**
1. ‚úÖ –ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è submit –æ–ø–µ—Ä–∞—Ü–∏–π (race conditions)
2. ‚úÖ Submit –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã –±–µ–∑ –º–µ—Ä–¥–∂–∞ (–ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö submit)

**–í–∞–∂–Ω—ã–µ:**
3. ‚ö†Ô∏è –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö sync (—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π, –Ω–æ –≤–æ–∑–º–æ–∂–µ–Ω)

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:**
4. ‚ö†Ô∏è –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `active_clients_count` –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
5. ‚ö†Ô∏è –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏

### 13.5. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–º —Å–µ—Å—Å–∏—è–º

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 1: –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è submit**

**–§–∞–π–ª:** `backend/core/views.py`, —Å—Ç—Ä–æ–∫–∏ 2478, 3344

**–ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è Listening:**
```python
from django.db import transaction

@transaction.atomic
def post(self, request, test_id=None, session_id=None):
    # ...
    if session_id:
        session = ListeningTestSession.objects.select_for_update().get(
            pk=session_id,
            user=request.user
        )
        if session.submitted:
            return Response({'error': 'Session already submitted'}, status=400)
        
        # ... –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ä–¥–∂ answers ...
        session.save()
```

**–ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è Reading:**
```python
@transaction.atomic
def put(self, request, session_id):
    session = ReadingTestSession.objects.select_for_update().get(
        pk=session_id,
        user=request.user
    )
    if session.completed:
        return Response({'error': 'Session already completed'}, status=400)
    
    # ... –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ä–¥–∂ answers ...
    session.save()
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –í–ê–ñ–ù–´–ô

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 2: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `last_updated` –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö sync**

**–§–∞–π–ª:** `backend/core/models.py`

**–ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```python
class ListeningTestSession(models.Model):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
    last_updated = models.DateTimeField(auto_now=True)  # –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º save()

class ReadingTestSession(models.Model):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
    last_updated = models.DateTimeField(auto_now=True)
```

**–§–∞–π–ª:** `backend/core/views.py`, –º–µ—Ç–æ–¥ `patch` –¥–ª—è sync

**–ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```python
def patch(self, request, session_id=None):
    session = get_object_or_404(ListeningTestSession, pk=session_id, user=request.user)
    
    if session.submitted:
        return Response({'error': 'Cannot sync a submitted session.'}, status=status.HTTP_400_BAD_REQUEST)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ)
    client_last_updated = request.data.get('last_updated')
    if client_last_updated:
        from django.utils.dateparse import parse_datetime
        client_time = parse_datetime(client_last_updated)
        if client_time and session.last_updated and client_time < session.last_updated:
            # –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∏–ª —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ, –Ω–æ –º—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –º–µ—Ä–∂–∏–º (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
            pass
    
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –º–µ—Ä–¥–∂–∞ answers ...
    
    session.save(update_fields=['answers', 'flagged', 'time_left', 'last_updated'])
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü¢ –û–ü–¶–ò–û–ù–ê–õ–¨–ù–´–ô

### 13.6. –í—ã–≤–æ–¥—ã –ø–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–º —Å–µ—Å—Å–∏—è–º

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- ‚úÖ –ë—ç–∫–µ–Ω–¥ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø–æ–¥ –ø–æ–ª–∏—Ç–∏–∫—É "–º–æ–∂–Ω–æ —Å —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤"
- ‚úÖ –í—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ —Å–µ—Å—Å–∏–µ–π –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/—Ç–µ—Å—Ç
- ‚ö†Ô∏è –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç race conditions –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- ‚ö†Ô∏è –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö sync

**–ß—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å:**
1. –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è submit (–∫—Ä–∏—Ç–∏—á–Ω–æ)
2. –î–æ–±–∞–≤–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ä–¥–∂ –ø—Ä–∏ submit (–∫—Ä–∏—Ç–∏—á–Ω–æ, —É–∂–µ –≤ –ø–ª–∞–Ω–µ)
3. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `last_updated` –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö sync (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- ‚úÖ –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- ‚úÖ –ù–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏